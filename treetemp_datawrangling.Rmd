---
title: "treetemp_datawrangling"
author: "Erika Lee"
date: "2024-06-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data Wrangling

```{r}
library(tidyverse)
library(lterdatasampler)
library(dplyr)
library(ggplot2)
library(readr)
library(readxl)
library(lubridate)
library(plotly)
library(openxlsx)
library(plotly)
library(rstatix)
library(htmlwidgets)
library(RColorBrewer)
library(patchwork)
library(xlsx)

setwd("/Volumes/wcnr-network/Research/Kampf/Private/field_data")
```

### Calling in data

Tree temp data

```{r}
#calling in tree temp data from n-drive
## burned
pers_b_aspects <- read_excel("nsf/105E_pers_burned/105E_pers_b_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

trans_b_aspects <- read_excel("nsf/105E_trans_burned/105E_trans_b_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

##unburned
pers_ub_aspects <- read_excel("nsf/105E_pers_unburned/105E_pers_ub_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

trans_ub_aspects <- read_excel("nsf/105E_trans_unburned/105E_trans_ub_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))
```

Weather Data

```{r}
#trans_burned 15-minute data

transb_wx_15min <- read_excel('nsf/trans_burned/trans_burned_wx_15min.xlsx')

#fix datetime issue and reorder - run this if I've added data to the trans_burned_wx_15min in n-drive
transb_wx_15min <- transb_wx_15min %>%
  drop_na(datetime) %>%
  mutate(datetime = ymd_hms(datetime, tz = 'MST')) %>%
  #reordering dataframe
  select(datetime, RECORD, Batt_volt, SnowDepth_m, AirTC_Avg, WS_ms_Avg, WindDir, RH, SWin_Avg, SWout_Avg, SWalbedo_Avg, LWin_Avg, LWout_Avg, SWnet_Avg, LWnet_Avg, NR_Avg, everything() )

#writing the 15min trans_ub weather to the n-drive
write.xlsx(transb_wx_15min, "nsf/trans_burned/trans_burned_wx_15min_r.xlsx")
```

```{r}
#manipulating trans unburned weather station data - ONLY run if you add new data to the trans_unburned composite excel sheet

transub_wx_15min <- read_excel("nsf/trans_unburned/trans_ub_wx_composite.xlsx") %>%
  #convert 5 min timestep to 15 minute timestep
  # Ensure the timestamp column is in datetime format
  mutate(TIMESTAMP = ymd_hms(TIMESTAMP)) %>%
  # Create a new column for 15-minute intervals
  mutate(interval = floor_date(TIMESTAMP, unit = "15 minutes")) %>%
  # Group by the 15-minute interval
  group_by(interval) %>%
  # Calculate the mean for all other columns
summarize(across(where(is.numeric), mean, na.rm = TRUE), .groups = 'drop') %>%  # Rename 'interval' to 'datetime' and remove the original 'datetime' column
  rename(datetime = interval) %>%
  #renaming columns to match trans/pers burned
  rename(Batt_volt = BattV_Avg) %>%
  rename(AirTC_Avg = AirTemp_Avg) %>%
  rename(RH = RH_Avg) %>%
  rename(WS_ms_Avg = WindSpeed) %>%
  rename(SnowDepth_m = SnowDepth_Avg) %>%
  select(datetime, RECORD, Batt_volt, SnowDepth_m, AirTC_Avg, WS_ms_Avg, WindDir, RH, SWin_Avg, SWout_Avg, SWalbedo_Avg, LWin_Avg, LWout_Avg, SWnet_Avg, LWnet_Avg, NR_Avg, everything() )
  
#writing the 15min trans_ub weather to the n-drive
write.xlsx(transub_wx_15min, "nsf/trans_unburned/trans_unburned_wx_15min_r.xlsx")
```

```{r}
#calling in weather station data from n-drive
##persistent zone
persb_wx_15min <- read_excel("nsf/pers_burned/pers_burned_wx_15min_r.xlsx")

persub_wx_15min <- read_excel("nsf/pers_unburned/pers_unburned_wx_15min_composite.xlsx") %>%
  mutate(datetime = ymd_hms(TIMESTAMP, tz = 'MST')) %>%
  select(datetime, everything()) %>%
  select(-TIMESTAMP)

##transitional
transb_wx_15min <- read_excel("nsf/trans_burned/trans_burned_wx_15min_r.xlsx") %>%
  mutate(datetime = ymd_hms(datetime, tz = 'MST'))

transub_wx_15min <- read_excel("nsf/trans_unburned/trans_ub_wx_15min_r.xlsx")
```

### Renaming weather dataframe columns so they match - ONLY run if needed

```{r}
#matching the transitional and persistent weather station headers
transb_wx_15min <- transb_wx_15min %>%
  rename(AirTC_Avg = AirT_C) %>%
  rename(RH = RH_percent) %>%
  rename(WS_ms_Avg = `WS_m/s`) %>%
  rename(WindDir = WindDir_deg) %>%
  rename(NR_Avg = Net_Rad_Avg) %>%
  rename(SWalbedo_Avg = SW_albedo) %>%
  #reordering dataframe
  select(datetime, RECORD, Batt_volt, SnowDepth_m, AirTC_Avg, WS_ms_Avg, WindDir, RH, SWin_Avg, SWout_Avg, SWalbedo_Avg, LWin_Avg, LWout_Avg, SWnet_Avg, LWnet_Avg, NR_Avg, everything())

write.xlsx(transb_wx_15min, "nsf/trans_burned/trans_burned_wx_15min_r.xlsx")

#reordering persistent weather station data
##pers burned
persb_wx_15min <- persb_wx_15min %>%
  rename(Batt_volt = BattV_Min) %>%
  #timestamp column is UTC time
  rename(SnowDepth_m = DBTCDT_Avg) %>%
  #applying offset to snow depth column for the pers_burned zone
  mutate(SnowDepth_m = (SnowDepth_m-0.03)) %>%
  select(datetime,TIMESTAMP, RECORD, Batt_volt, SnowDepth_m, AirTC_Avg, WS_ms_Avg, WindDir, RH, SWin_Avg, SWout_Avg, SWalbedo_Avg, LWin_Avg, LWout_Avg, SWnet_Avg, LWnet_Avg, NR_Avg, everything())

write.xlsx(persb_wx_15min, "nsf/pers_burned/pers_burned_wx_15min_r.xlsx")

##pers unburned
persub_wx_15min <- persub_wx_15min %>%
  rename(Batt_volt = BattV_Min) %>%
  rename(SnowDepth_m = DBTCDT_Avg) %>%
  #creating an RH average column to match pers burned and trans burned dataframes
  mutate(RH = mean(c(RH_Min, RH_Max))) %>%
  #changing timestamp column from UTC to MST
  mutate(datetime = with_tz(TIMESTAMP, "America/Denver")) %>%
  filter(datetime >= ymd_hms("2023-12-07 00:00:00", tz = 'MST')) %>%
  select(datetime,TIMESTAMP, RECORD, Batt_volt, SnowDepth_m, AirTC_Avg, WS_ms_Avg, WindDir, RH, SWin_Avg, SWout_Avg, SWalbedo_Avg, LWin_Avg, LWout_Avg, SWnet_Avg, LWnet_Avg, NR_Avg, everything())

##writing edited persistent unburned dataframe to n-drive
write.xlsx(persub_wx_15min, "nsf/pers_unburned/pers_unburned_wx_15min_r.xlsx")
```

### Setting consistent timeframe

```{r}
#setting a consistent timeframe for all tree temp data for all burned/unburned zones
##has to start at 2024-02-02 due to errors in data at transitional burned site

#tree temp dataframes
start_time <- ymd_hms("2024-02-02 00:00:00")
end_time <- ymd_hms("2024-05-24 00:00:00")

filtered_pers_b_aspects <- pers_b_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_pers_ub_aspects <- pers_ub_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_trans_b_aspects <- trans_b_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_trans_ub_aspects <- trans_ub_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)
```

```{r}
#setting consistent timeframe for weather data
#filtered weather dataframes
filtered_persb_wx_15min <- persb_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  #removed UTM column
  select(-TIMESTAMP)

filtered_persub_wx_15min <- persub_wx_15min %>%
  select(datetime, everything()) %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  #removed UTM column
  select(-TIMESTAMP)
  
filtered_transb_wx_15min <- transb_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_transun_wx_15min <- transub_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time)
```

# Tree Temp Comparison

```{r}
#adding in a burn status column to the aspect dataframes
filtered_pers_b_aspects <- filtered_pers_b_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "gb") ~ "green burn",
    startsWith(tree_name, "db") ~ "dead burn",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "persistent")

filtered_pers_ub_aspects <- filtered_pers_ub_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "ub") ~ "alive",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "persistent")

filtered_trans_b_aspects <- filtered_trans_b_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "gb") ~ "green burn",
    startsWith(tree_name, "db") ~ "dead burn",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "transitional")

filtered_trans_ub_aspects <- filtered_trans_ub_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "ub") ~ "alive",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  mutate(zone = "transitional")
```

## Differencing Dead burn and Green burn trees - For Plotting later!

### Persistent Zone

```{r}
#creating a dataframe with green burn temp minus dead burn temp for the same aspects
##north aspect
persb_north_diff_data <- filtered_pers_b_aspects %>%
  # Filter for north aspect
  filter(aspect == 'north') %>%
  # Filter out gb_w tree
  filter(tree_name != 'gb_w') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    gb_e_minus_db_s = mean(temp[tree_name == 'gb_e']) - mean(temp[tree_name == 'db_s']),
    gb_s_minus_db_s = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_s']),
    gb_e_minus_db_n = mean(temp[tree_name == 'gb_e']) - mean(temp[tree_name == 'db_n']),
    gb_s_minus_db_n = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_n'])
  ) %>%
  ungroup()

# Reshape data to long format
persb_north_diff_long <- persb_north_diff_data %>%
  pivot_longer(cols = starts_with("gb"), names_to = "comparison", values_to = "difference") %>%
  #adding in a zone and a burn status for later dataframe combinations
  mutate(burn_status = "burned") %>%
  mutate(zone = "persistent") %>%
  mutate(aspect = "north")
```

North Aspect Boxplots

```{r}
# Plotting the boxplots
persb_north_diff_plot <- ggplot(persb_north_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "North Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(persb_north_diff_plot)
```

```{r}
##south aspect
persb_south_diff_data <- filtered_pers_b_aspects %>%
  # Filter for north aspect
  filter(aspect == 'south') %>%
  # Filter out gb_w tree
  filter(tree_name != 'gb_w') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    gb_e_minus_db_s = mean(temp[tree_name == 'gb_e']) - mean(temp[tree_name == 'db_s']),
    gb_s_minus_db_s = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_s']),
    gb_e_minus_db_n = mean(temp[tree_name == 'gb_e']) - mean(temp[tree_name == 'db_n']),
    gb_s_minus_db_n = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_n'])
  ) %>%
  ungroup()

# Reshape data to long format
persb_south_diff_long <- persb_south_diff_data %>%
  pivot_longer(cols = starts_with("gb"), names_to = "comparison", values_to = "difference") %>%
  #adding in a zone and a burn status for later dataframe combinations
  mutate(burn_status = "burned") %>%
  mutate(zone = "persistent") %>%
  mutate(aspect = "south")
```

South Aspect Boxplots

```{r}
# Plotting the boxplots
persb_south_diff_plot <- ggplot(persb_south_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "South Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(persb_south_diff_plot)
```

Combining Plots

```{r}
#combinging north and south plots
persb_combined_aspectdiff_treetemp_plots <- persb_north_diff_plot + persb_south_diff_plot + plot_layout(nrow = 2) + plot_annotation(title = "Persistent Zone, Green & Dead Burn Tree Temp Difference")

persb_combined_aspectdiff_treetemp_plots 

#saving combined plot
ggsave("persb_combined_aspectdiff_treetemp_plots.png", plot = persb_combined_aspectdiff_treetemp_plots , width = 8, height = 10, dpi = 300, bg = "white")
```

### Transitional Zone

```{r}
#creating a dataframe with green burn temp minus dead burn temp for the same aspects
##north aspect
transb_north_diff_data <- filtered_trans_b_aspects %>%
  # Filter for north aspect
  filter(aspect == 'north') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    gb_n_minus_db_s = mean(temp[tree_name == 'gb_n']) - mean(temp[tree_name == 'db_s']),
    gb_s_minus_db_s = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_s']),
    gb_n_minus_db_n = mean(temp[tree_name == 'gb_n']) - mean(temp[tree_name == 'db_n']),
    gb_s_minus_db_n = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_n'])
  ) %>%
  ungroup()

# Reshape data to long format
transb_north_diff_long <- transb_north_diff_data %>%
  pivot_longer(cols = starts_with("gb"), names_to = "comparison", values_to = "difference") %>%
  #adding in a zone and a burn status for later dataframe combinations
  mutate(burn_status = "burned") %>%
  mutate(zone = "transitional") %>%
  mutate(aspect = "north")
```

North Aspect Boxplots

```{r}
# Plotting the boxplots
transb_north_diff_plot <- ggplot(transb_north_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "North Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(transb_north_diff_plot)
```

```{r}
##south aspect
transb_south_diff_data <- filtered_trans_b_aspects %>%
  # Filter for north aspect
  filter(aspect == 'south') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    gb_n_minus_db_s = mean(temp[tree_name == 'gb_n']) - mean(temp[tree_name == 'db_s']),
    gb_s_minus_db_s = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_s']),
    gb_n_minus_db_n = mean(temp[tree_name == 'gb_n']) - mean(temp[tree_name == 'db_n']),
    gb_s_minus_db_n = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_n'])
  ) %>%
  ungroup()

# Reshape data to long format
transb_south_diff_long <- transb_south_diff_data %>%
  pivot_longer(cols = starts_with("gb"), names_to = "comparison", values_to = "difference") %>%
  #adding in a zone and a burn status for later dataframe combinations
  mutate(burn_status = "burned") %>%
  mutate(zone = "transitional") %>%
  mutate(aspect = "south")
```

South Aspect Boxplots

```{r}
# Plotting the boxplots
transb_south_diff_plot <- ggplot(transb_south_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "South Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(transb_south_diff_plot)
```

Combining Plots

```{r}
#combinging north and south plots
transb_combined_aspectdiff_treetemp_plots <- transb_north_diff_plot + transb_south_diff_plot + plot_layout(nrow = 2) + plot_annotation(title = "Transitional Zone, Green & Dead Burn Tree Temp Difference")

transb_combined_aspectdiff_treetemp_plots 

#saving combined plot
ggsave("transb_combined_aspectdiff_treetemp_plots.png", plot = transb_combined_aspectdiff_treetemp_plots , width = 8, height = 10, dpi = 300, bg = "white")
```

Combining Dataframes

```{r}
#creating a combined dataframe for the db-gb comparisons
full_dbgb_comparisons_data <- bind_rows(persb_north_diff_long, persb_south_diff_long, transb_north_diff_long, transb_south_diff_long)
```

Saving Combined dataframe

```{r}
write_csv(full_dbgb_comparisons_data, "nsf/treetemp_data/full_dbgb_comparisons_data.csv")
```

## Differencing by Individual Tree Aspect

### Persistent Zone

```{r}
#creating a dataframe for each tree
persb_gb_e_diff_data <- filtered_pers_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'gb_e') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'gb_e')

persb_gb_s_diff_data <- filtered_pers_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'gb_s') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'gb_s')

persb_db_n_diff_data <- filtered_pers_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'db_n') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'db_n')

persb_db_s_diff_data <- filtered_pers_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'db_s') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'db_s')

#creating a combined new dataframe
persb_gbdb_combined_data <- bind_rows(persb_gb_e_diff_data, persb_gb_s_diff_data, persb_db_n_diff_data, persb_db_s_diff_data)
```

Plotting

```{r}
#plotting persistent north-south tree boxplots
persb_gbdb_diff_plot <- ggplot(persb_gbdb_combined_data, aes(x = comparison, y = difference, fill = treename)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Persistent Zone",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Name")

print(persb_gbdb_diff_plot)
```

### Transitional Zone

```{r}
#creating a dataframe for each tree
transb_gb_n_diff_data <- filtered_trans_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'gb_n') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'gb_n')

transb_gb_s_diff_data <- filtered_trans_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'gb_s') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'gb_s')

transb_db_n_diff_data <- filtered_trans_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'db_n') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'db_n')

transb_db_s_diff_data <- filtered_trans_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'db_s') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'db_s')

#creating a combined new dataframe
transb_gbdb_combined_data <- bind_rows(transb_gb_n_diff_data, transb_gb_s_diff_data, transb_db_n_diff_data, transb_db_s_diff_data)
```

Plotting

```{r}
#plotting transitional north-south tree boxplots
transb_gbdb_diff_plot <- ggplot(transb_gbdb_combined_data, aes(x = comparison, y = difference, fill = treename)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Transitional Zone",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Name")

print(transb_gbdb_diff_plot)
```

Combined Plots

```{r}
#combinging north and south plots
combined_bytree_aspect_treetemp_plots <- persb_gbdb_diff_plot + transb_gbdb_diff_plot + plot_layout(nrow = 1) + plot_annotation(title = "Temperature Differences by Tree - south minus north aspect")

combined_bytree_aspect_treetemp_plots

#saving combined plot
ggsave("combined_bytree_aspect_treetemp_plots.png", plot = combined_bytree_aspect_treetemp_plots , width = 10, height = 6, dpi = 300, bg = "white")
```

Combined NS Dataframe

```{r}
#creating a full dataframe for both pers and transitional data for later plotting of the south-north comparison

##individually editing pers and trans combined data before combining both dataframes
# Add new column 'burn_status' based on conditions, and new column 'zone' based on location
persb_gbdb_combined_data <- persb_gbdb_combined_data %>%
  mutate(burn_status = case_when(
    startsWith(treename, "gb") ~ "green_burned",
    startsWith(treename, "db") ~ "dead_burned",
    TRUE ~ NA_character_  # Handle other cases if needed
  )) %>%
  mutate(zone = "persistent")

transb_gbdb_combined_data <- transb_gbdb_combined_data %>%
  mutate(burn_status = case_when(
    startsWith(treename, "gb") ~ "green_burned",
    startsWith(treename, "db") ~ "dead_burned",
    TRUE ~ NA_character_  # Handle other cases if needed
  )) %>%
  mutate(zone = "transitional")

#creating a full combined dataset
full_ns_comparison_data <- bind_rows(persb_gbdb_combined_data, transb_gbdb_combined_data)
```

```{r}
#exporting full ns comparison dataframe
write_csv(full_ns_comparison_data, "nsf/treetemp_data/full_ns_comparison_data.csv")
```

**Interpretation of box plots**

-   Consistent Boxes: Similar boxes indicate that the general trend and variability within the middle 50% of the data are consistent across different aspects.

-   Many Outliers: The numerous outliers highlight that there are frequent instances of temperature differences that are much higher or lower than the typical range. This could point to specific factors or conditions that cause these deviations.

# Pivoting to long dataframes for temp comparisons

```{r}
#creating a combined new dataframe from original dataframes with individual tree temps - May not want a full combined dataset!
full_burned_combined_data <- bind_rows(filtered_pers_b_aspects, filtered_trans_b_aspects)

full_unburned_combined_data <- bind_rows(filtered_pers_ub_aspects, filtered_trans_ub_aspects)
```

Combined Full, Filtered Aspect/temp dataframes

```{r}
#exporting important dataframes to N-Drive. These are what are used for stats calculations
write_csv(full_burned_combined_data, "nsf/treetemp_data/full_burned_combined_data.csv")

write_csv(full_unburned_combined_data, "nsf/treetemp_data/full_unburned_combined_data.csv")
```

## N/S Aspect Dataframes

### Pers_b

Creating a clean dataframe with columns for north and south temps, instead of rows (wide format)

```{r}
#persistent burned 

full_pers_ns_data <- full_burned_combined_data %>%
  filter(!(aspect %in% c("charred", "uncharred"))) %>%
  filter(zone == "persistent") %>%
  #remove gb_w tree, so there is two gb and two db
  filter(!(tree_name == "gb_w")) %>%
  #getting mean temperature of all trees, instead of having individual trees identified
  group_by(datetime, aspect, zone, burn_status) %>%
  # Calculate the mean temperature for each aspect
  summarize(mean_temp = mean(temp, na.rm = TRUE), .groups = 'drop')

final_persb_ns_temps <- full_pers_ns_data %>%
  group_by(datetime, burn_status, zone) %>%
  pivot_wider(names_from = aspect, values_from = mean_temp) %>%
  rename(north_temp = north, south_temp = south) %>%
  summarize(north_temp, south_temp)
```

### Pers_ub

```{r}
#persistent unburned final dataset
full_pers_ub_ns_data <- full_unburned_combined_data %>%
  mutate(burn_status = "unburned") %>%
  filter(zone == "persistent") %>%
  #getting mean temperature of all trees, instead of having individual trees identified
  group_by(datetime, aspect, zone, burn_status) %>%
  # Calculate the mean temperature for each aspect
  summarize(mean_temp = mean(temp, na.rm = TRUE), .groups = 'drop')

final_pers_ub_ns_temps <- full_pers_ub_ns_data %>%
  group_by(datetime, burn_status, zone) %>%
  pivot_wider(names_from = aspect, values_from = mean_temp) %>%
  rename(north_temp = north, south_temp = south) %>%
  summarize(north_temp, south_temp)
```

```{r}
#creating a full n/s green burned, db, ub dataframe to do comparisons on later
full_pers_ns_data <- final_persb_ns_temps %>%
  full_join(final_pers_ub_ns_temps)
```

### Trans_b

```{r}
#transitional burned 

full_trans_ns_data <- full_burned_combined_data %>%
  filter(!(aspect %in% c("charred", "uncharred"))) %>%
  filter(zone == "transitional") %>%
  #getting mean temperature of all trees, instead of having individual trees identified
  group_by(datetime, aspect, zone, burn_status) %>%
  # Calculate the mean temperature for each aspect
  summarize(mean_temp = mean(temp, na.rm = TRUE), .groups = 'drop')

final_transb_ns_temps <- full_trans_ns_data %>%
  group_by(datetime, burn_status, zone) %>%
  pivot_wider(names_from = aspect, values_from = mean_temp) %>%
  rename(north_temp = north, south_temp = south) %>%
  summarize(north_temp, south_temp)
```

### Trans_ub

```{r}
#tranitional unburned final dataset
full_trans_ub_ns_data <- full_unburned_combined_data %>%
  mutate(burn_status = "unburned") %>%
  filter(zone == "transitional") %>%
  #getting mean temperature of all trees, instead of having individual trees identified
  group_by(datetime, aspect, zone, burn_status) %>%
  # Calculate the mean temperature for each aspect
  summarize(mean_temp = mean(temp, na.rm = TRUE), .groups = 'drop')

final_trans_ub_ns_temps <- full_trans_ub_ns_data %>%
  group_by(datetime, burn_status, zone) %>%
  pivot_wider(names_from = aspect, values_from = mean_temp) %>%
  rename(north_temp = north, south_temp = south) %>%
  summarize(north_temp, south_temp)
```

```{r}
#creating a full n/s green burned, db, ub dataframe to do comparisons on later
full_trans_ns_data <- final_transb_ns_temps %>%
  full_join(final_trans_ub_ns_temps)
```

## DB/GB/UB Dataframes \*\*\*

### Pers_b

Creating a clean dataframe with columns for gb, db, and ub temps, instead of rows (wide format)

```{r}
#persistent burned 

full_pers_gbdb_data <- full_burned_combined_data %>%
  filter(!(aspect %in% c("charred", "uncharred"))) %>%
  filter(zone == "persistent", aspect == "south") %>%
  #remove gb_w tree, so there is two gb and two db
  filter(!(tree_name == "gb_w"))

clean_persb_gbdb_temps <- full_pers_gbdb_data %>%
  group_by(datetime, burn_status, zone, aspect) %>%
  pivot_wider(names_from = burn_status, values_from = temp) %>%
  rename(gb_temp = "green burn", db_temp = "dead burn") %>%
  # Selecting only rows where tree_name is "gb_s" or "db_s"
  filter(tree_name %in% c("gb_s", "db_s")) %>%
  select(c(-tree_name, -sensor_id))


##creatinging individual dataframes for north and south temps, then going to rebind them to get rid of the NA issues
gb_persb_temps <- clean_persb_gbdb_temps %>%
  select(-db_temp) %>%
  # Filter out rows with NA
  filter(!is.na(gb_temp))

db_persb_temps <- clean_persb_gbdb_temps %>%
  select(-gb_temp) %>%
  filter(!is.na(db_temp))

##joining north/south dataframes
final_persb_gbdb_temps <- gb_persb_temps %>%
  full_join(db_persb_temps, by = c("datetime", "aspect", "zone"))
```

### Trans_b

```{r}
#transitional burned 

full_trans_gbdb_data <- full_burned_combined_data %>%
  #there is a missing datetime for db_north, so I have to filter this dataset specifically to exclude the first datetime reading
  filter(!(aspect %in% c("charred", "uncharred"))) %>%
  filter(zone == "transitional", aspect == "south")

clean_transb_gbdb_temps <- full_trans_gbdb_data %>%
  group_by(datetime, burn_status, zone, aspect) %>%
  pivot_wider(names_from = burn_status, values_from = temp) %>%
  rename(gb_temp = "green burn", db_temp = "dead burn") %>%
  # Selecting only rows where tree_name is "gb_s" or "db_s"
  filter(tree_name %in% c("gb_s", "db_s")) %>%
  select(c(-tree_name, -sensor_id))


##creatinging individual dataframes for north and south temps, then going to rebind them to get rid of the NA issues
gb_transb_temps <- clean_transb_gbdb_temps %>%
  select(-db_temp) %>%
  # Filter out rows with NA
  filter(!is.na(gb_temp))

db_transb_temps <- clean_transb_gbdb_temps %>%
  select(-gb_temp) %>%
  filter(!is.na(db_temp))

##joining north/south dataframes
final_transb_gbdb_temps <- gb_transb_temps %>%
  full_join(db_transb_temps, by = c("datetime", "aspect", "zone"))
```

### Pers_ub

```{r}
full_pers_ub_data <- full_unburned_combined_data %>%
  filter(zone == "persistent", aspect == "south")

clean_pers_ub_temps <- full_pers_ub_data %>%
  group_by(datetime, burn_status, zone, aspect) %>%
  pivot_wider(names_from = burn_status, values_from = temp) %>%
  rename(ub_temp = "alive") %>%
  #selecting one tree, "ub_s"
  filter(tree_name == "ub_s") %>%
  select(c(-tree_name, -sensor_id))

# final pers_ub temps dataframe
final_pers_ub_temps <- clean_pers_ub_temps
```

### Trans_ub

```{r}
full_trans_ub_data <- full_unburned_combined_data %>%
  filter(zone == "transitional", aspect == "south")

clean_trans_ub_temps <- full_trans_ub_data %>%
  group_by(datetime, burn_status, zone, aspect) %>%
  pivot_wider(names_from = burn_status, values_from = temp) %>%
  rename(ub_temp = "alive") %>%
  #selecting one tree, "ub_e"
  filter(tree_name == "ub_e") %>%
  select(c(-tree_name, -sensor_id))

# final pers_ub temps dataframe
final_trans_ub_temps <- clean_trans_ub_temps
```

# Final 15-minute Dataframes

Combining burned and unburned dataframes by zone and 15-minute timestep - this is what is used for stats calculations

-   important step
-   Also adding avg_temp for 15-minute timestep

## North/South Aspects

```{r}
#combining persistent and transitional unburned to create a 15min_unburned datatable

final_15min_ns_ub <- bind_rows(final_pers_ub_ns_temps, final_trans_ub_ns_temps) %>%
  #adding in day & month
  mutate(day = as.Date(datetime), month = month(datetime)) %>%
  #adding in mean temp of north and south temps
  mutate(avg_temp = mean((south_temp + north_temp) / 2)) %>%
  mutate(burn_status = "unburned") %>%
  select(datetime, day, month, zone, burn_status, tree_name, everything())
```

```{r}
#combining persistent and transitional burnedto create a 15min_burned datatable
final_15min_ns_b <- bind_rows(final_persb_ns_temps, final_transb_ns_temps) %>%
  #adding in day & month
  mutate(day = as.Date(datetime), month = month(datetime)) %>%
  group_by(datetime, zone, burn_status)


  #adding in mean temp of north and south temps
  mutate(avg_temp = mean((south_temp + north_temp) / 2)) %>%
  select(datetime, day, month, zone, burn_status, tree_name, everything())
```

```{r}
#writing final n/s combined dataframes to n-drive
write_csv(final_15min_ns_b, "nsf/treetemp_data/final_15min_ns_b.csv")

write_csv(final_15min_ns_ub, "nsf/treetemp_data/final_15min_ns_ub.csv")
```

## GB/DB/UB Aspects

```{r}
# GB/DB comparison
final_15min_gbdb <- bind_rows(final_persb_gbdb_temps, final_transb_gbdb_temps) %>%
  #adding in day & month
  mutate(day = as.Date(datetime), month = month(datetime)) %>%
  #adding in mean temp of north and south temps
  mutate(avg_temp = mean((gb_temp + db_temp) / 2)) %>%
  select(datetime, day, month, zone, everything())
```

```{r}
#creating dataframe for combined ub temps

final_15min_gbdb_ub <- bind_rows(final_pers_ub_temps, final_trans_ub_temps) %>%
  #adding in day & month
  mutate(day = as.Date(datetime), month = month(datetime)) %>%
  select(datetime, day, month, zone, everything())
```

```{r}
#GB/UB comparison

##have to create a new dataframe for this step that gets rid of db temps
final_gb_temps <- final_15min_gbdb %>%
  select(c(-db_temp, -avg_temp))

final_15min_gbub <- final_gb_temps %>%
  full_join(final_15min_gbdb_ub, by = c("datetime", "day", "month", "aspect", "zone")) %>%
  #adding in mean temp of north and south temps
  mutate(avg_temp = mean((gb_temp + ub_temp) / 2)) %>%
  select(datetime, day, month, zone, everything())
```

```{r}
#DB/UB comparison
final_db_temps <- final_15min_gbdb %>%
  select(c(-gb_temp, -avg_temp))

final_15min_dbub <- final_db_temps %>%
  full_join(final_15min_gbdb_ub, by = c("datetime", "day", "month", "aspect", "zone")) %>%
  #adding in mean temp of north and south temps
  mutate(avg_temp = mean((db_temp + ub_temp) / 2)) %>%
  select(datetime, day, month, zone, everything())
```

### Writing CSV

```{r}
#writing final gb/db/ub 15-minute comparison dataframes to n-drive
write_csv(final_15min_gbdb, "nsf/treetemp_data/final_15min_gbdb.csv")

#this one is only the unburned temps! Not a comparison
write_csv(final_15min_gbdb_ub, "nsf/treetemp_data/final_15min_gbdb_ub.csv")

write_csv(final_15min_gbub, "nsf/treetemp_data/final_15min_gbub.csv")

write_csv(final_15min_dbub, "nsf/treetemp_data/final_15min_dbub.csv")
```

# Day/Night timeframes

## Creating day-only dataframes

```{r}
#persistent daytime dataframes
dt_pers_b_aspects <- filtered_pers_b_aspects %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)

dt_pers_ub_aspects <- filtered_pers_ub_aspects %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)

#transitional daytime dataframes
dt_trans_b_aspects <- filtered_trans_b_aspects %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)

dt_trans_ub_aspects <- filtered_trans_ub_aspects %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)
```

## Plotting - DB/GB differencing

### Persistent Zone

```{r}
#manipulating the dataset to only be hours between 6 am and 9 pm MST
dt_persb_north_diff_long <- persb_north_diff_long %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)

dt_persb_south_diff_long <- persb_south_diff_long %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)
```

Plotting

```{r}
#plotting
dt_persb_north_diff_plot <- ggplot(dt_persb_north_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Daytime North Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(dt_persb_north_diff_plot)

dt_persb_south_diff_plot <- ggplot(dt_persb_south_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Daytime South Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(dt_persb_south_diff_plot)
```

## Plotting - aspect differencing

### Persistent Zone

```{r}
#creating new dataframe with only daytime hours
dt_persb_gbdb_combined_data <- persb_gbdb_combined_data %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)
```

```{r}
#plotting
dt_persb_gbdb_diff_plot <- ggplot(dt_persb_gbdb_combined_data, aes(x = comparison, y = difference, fill = treename)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Daytime Persistent Zone",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Name")

print(dt_persb_gbdb_diff_plot)
```

### Transitional Zone

```{r}
#creating new dataframe with only daytime hours
dt_transb_gbdb_combined_data <- transb_gbdb_combined_data %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)
```

Plotting

```{r}
#plotting
dt_transb_gbdb_diff_plot <- ggplot(dt_transb_gbdb_combined_data, aes(x = comparison, y = difference, fill = treename)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Daytime Transitional Zone",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Name")

print(dt_transb_gbdb_diff_plot)
```

# Day vs Night Stats Dataframes

### Calling in Data

The single_avg temps are where a single tree was chosen, then the north/south aspects were averaged

```{r}
#dataframe with single mean daily values calculated for daytime and nighttime, averaging not between N/S but for all trees.
single_avg_all_treetemps <- read_excel("nsf/single_avg_all_treetemps.xlsx")
```

Data Wrangling

```{r}
#manipulating dataframe to run stats on
stats_single_avg_all_treetemps <- single_avg_all_treetemps %>%
  group_by(date, phase, burn_status, zone) %>%
  pivot_wider(names_from = phase, values_from = avg_temp) %>%
  rename(avg_day_temp = day, avg_night_temp = night) %>%
  reframe(avg_day_temp, avg_night_temp)
  
##creatinging individual dataframes for day and night temps, then going to rebind them to get rid of the NA issues
day_all_temps <- stats_single_avg_all_treetemps %>%
  select(-avg_night_temp) %>%
  filter(!is.na(avg_day_temp))# Filter out rows with NA

night_all_temps <- stats_single_avg_all_treetemps %>%
  select(-avg_day_temp) %>%
  filter(!is.na(avg_night_temp))

##joining north/south dataframes
final_daynight_singleavg_temps <- day_all_temps %>%
  inner_join(night_all_temps) %>%
  #adding in week and month columns
  mutate(
    month = format(date, "%Y-%m"),
    week = week(date)  # Extract week number from datetime
  ) %>%
  mutate(avg_temp = (avg_day_temp + avg_night_temp) / 2)
```

Exporting final daynight single_avg dataset

```{r}
write_csv(final_daynight_singleavg_temps, "nsf/treetemp_data/final_daynight_singleavg_temps.csv")
```

# Creating a single comparison dataframe for N/S and GB/DB/UB comparisons and stats

### 15-minute timestep

```{r}
full_15min_ns <- bind_rows(full_pers_ns_data, full_trans_ns_data) %>%
  #adding in day, month and time columns
  mutate(day = as.Date(datetime), month = month(datetime), time = format(datetime, "%H:%M:%S")) %>%
#adding in mean temp of gbdb/gbub/dbub temps
  mutate(ns_avg_temp = mean((north_temp + south_temp) / 2)) %>%
  select(datetime, time, day, month, zone, everything()) %>%
  #calculating temp difference for 15-minute intervals
  mutate(temp_diff = south_temp - north_temp)
```

```{r}
# GB/DB/UB comparison
full_15min_gbdbub <- bind_rows(final_persb_gbdb_temps, final_transb_gbdb_temps) %>%
  full_join(final_15min_gbdb_ub) %>%
  #adding in day, month and time columns
  mutate(day = as.Date(datetime), month = month(datetime), time = format(datetime, "%H:%M:%S")) %>%
  #adding in mean temp of gbdb/gbub/dbub temps
  mutate(gbdb_avg_temp = mean((gb_temp + db_temp) / 2)) %>%
  mutate(gbub_avg_temp = mean((gb_temp + ub_temp) / 2)) %>%
  mutate(dbub_avg_temp = mean((db_temp + ub_temp) / 2)) %>%
  select(datetime, time, day, month, zone, everything()) %>%
  #calculating temp_diff for 15-minute interval
  mutate(gbdb_temp_diff = gb_temp - db_temp) %>%
  mutate(gbub_temp_diff = gb_temp - ub_temp) %>%
  mutate(dbub_temp_diff = db_temp - ub_temp)
```

Exporting full 15-minute gbdbub and n/s comparison dataframes

```{r}
write_csv(full_15min_ns, "nsf/treetemp_data/full_15min_ns.csv")

write_csv(full_15min_gbdbub, "nsf/treetemp_data/full_15min_gbdbub.csv")
```
