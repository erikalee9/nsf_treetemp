---
title: "treetemp_datawrangling"
author: "Erika Lee"
date: "2024-06-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data Wrangling

```{r}
library(tidyverse)
library(lterdatasampler)
library(dplyr)
library(ggplot2)
library(readr)
library(readxl)
library(lubridate)
library(plotly)
library(openxlsx)
library(plotly)
library(rstatix)
library(htmlwidgets)
library(RColorBrewer)
library(patchwork)
library(xlsx)

setwd("/Volumes/wcnr-network/Research/Kampf/Private/field_data")
```

### Calling in data

```{r}
#calling in tree temp data from n-drive
## burned
pers_b_aspects <- read_excel("nsf/105E_pers_burned/105E_pers_b_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

trans_b_aspects <- read_excel("nsf/105E_trans_burned/105E_trans_b_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

##unburned
pers_ub_aspects <- read_excel("nsf/105E_pers_unburned/105E_pers_ub_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

trans_ub_aspects <- read_excel("nsf/105E_trans_unburned/105E_trans_ub_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))
```

```{r}
#manipulating trans unburned weather station data - ONLY run if you add new data to the trans_unburned composite excel sheet

transub_wx_15min <- read_excel("nsf/trans_unburned/trans_ub_wx_composite.xlsx") %>%
  #convert 5 min timestep to 15 minute timestep
  # Ensure the timestamp column is in datetime format
  mutate(TIMESTAMP = ymd_hms(TIMESTAMP)) %>%
  # Create a new column for 15-minute intervals
  mutate(interval = floor_date(TIMESTAMP, unit = "15 minutes")) %>%
  # Group by the 15-minute interval
  group_by(interval) %>%
  # Calculate the mean for all other columns
summarize(across(where(is.numeric), mean, na.rm = TRUE), .groups = 'drop') %>%  # Rename 'interval' to 'datetime' and remove the original 'datetime' column
  rename(datetime = interval) %>%
  #renaming columns to match trans/pers burned
  rename(Batt_volt = BattV_Avg) %>%
  rename(AirTC_Avg = AirTemp_Avg) %>%
  rename(RH = RH_Avg) %>%
  rename(WS_ms_Avg = WindSpeed) %>%
  rename(SnowDepth_m = SnowDepth_Avg) %>%
  select(datetime, RECORD, Batt_volt, SnowDepth_m, AirTC_Avg, WS_ms_Avg, WindDir, RH, SWin_Avg, SWout_Avg, SWalbedo_Avg, LWin_Avg, LWout_Avg, SWnet_Avg, LWnet_Avg, NR_Avg, everything() )
  
#writing the 15min trans_ub weather to the n-drive
write.xlsx(transub_wx_15min, "nsf/trans_unburned/trans_unburned_wx_15min_r.xlsx")
```

```{r}
#calling in weather station data from n-drive
##persistent zone
persb_wx_15min <- read_excel("nsf/pers_burned/pers_burned_wx_15min_r.xlsx")

persub_wx_15min <- read_excel("nsf/pers_unburned/pers_unburned_wx_15min_composite.xlsx")

##transitional
transb_wx_15min <- read_excel("nsf/trans_burned/trans_burned_wx_15min_r.xlsx")

transub_wx_15min <- read_excel("nsf/trans_unburned/trans_ub_wx_15min_r.xlsx")
```

### Renaming weather dataframe columns so they match

```{r}
#matching the transitional and persistent weather station headers
transb_wx_15min <- transb_wx_15min %>%
  rename(AirTC_Avg = AirT_C) %>%
  rename(RH = RH_percent) %>%
  rename(WS_ms_Avg = `WS_m/s`) %>%
  rename(WindDir = WindDir_deg) %>%
  rename(NR_Avg = RN_Avg) %>%
  rename(SWalbedo_Avg = SW_albedo) %>%
  #reordering dataframe
  select(datetime, RECORD, Batt_volt, SnowDepth_m, AirTC_Avg, WS_ms_Avg, WindDir, RH, SWin_Avg, SWout_Avg, SWalbedo_Avg, LWin_Avg, LWout_Avg, SWnet_Avg, LWnet_Avg, NR_Avg, everything() )

write.xlsx(transb_wx_15min, "nsf/trans_burned/trans_burned_wx_15min_r.xlsx")

#reordering persistent weather station data
##pers burned
persb_wx_15min <- persb_wx_15min %>%
  rename(Batt_volt = BattV_Min) %>%
  #timestamp column is UTC time
  rename(SnowDepth_m = DBTCDT_Avg) %>%
  #applying offset to snow depth column for the pers_burned zone
  mutate(SnowDepth_m = (SnowDepth_m-0.03)) %>%
  select(datetime,TIMESTAMP, RECORD, Batt_volt, SnowDepth_m, AirTC_Avg, WS_ms_Avg, WindDir, RH, SWin_Avg, SWout_Avg, SWalbedo_Avg, LWin_Avg, LWout_Avg, SWnet_Avg, LWnet_Avg, NR_Avg, everything())

write.xlsx(persb_wx_15min, "nsf/pers_burned/pers_burned_wx_15min_r.xlsx")

##pers unburned
persub_wx_15min <- persub_wx_15min %>%
  rename(Batt_volt = BattV_Min) %>%
  rename(SnowDepth_m = DBTCDT_Avg) %>%
  #creating an RH average column to match pers burned and trans burned dataframes
  mutate(RH = mean(c(RH_Min, RH_Max))) %>%
  #changing timestamp column from UTC to MST
  mutate(datetime = with_tz(TIMESTAMP, "America/Denver")) %>%
  filter(datetime >= ymd_hms("2023-12-07 00:00:00", tz = 'MST')) %>%
  select(datetime,TIMESTAMP, RECORD, Batt_volt, SnowDepth_m, AirTC_Avg, WS_ms_Avg, WindDir, RH, SWin_Avg, SWout_Avg, SWalbedo_Avg, LWin_Avg, LWout_Avg, SWnet_Avg, LWnet_Avg, NR_Avg, everything())

##writing edited persistent unburned dataframe to n-drive
write.xlsx(persub_wx_15min, "nsf/pers_unburned/pers_unburned_wx_15min_r.xlsx")
```

### Setting consistent timeframe

```{r}
#setting a consistent timeframe for all tree temp data for all burned/unburned zones
##has to start at 2024-02-02 due to errors in data at transitional burned site

#tree temp dataframes
start_time <- ymd_hms("2024-02-02 00:00:00")
end_time <- ymd_hms("2024-05-24 00:00:00")

filtered_pers_b_aspects <- pers_b_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_pers_ub_aspects <- pers_ub_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_trans_b_aspects <- trans_b_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_trans_ub_aspects <- trans_ub_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)
```

```{r}
#setting consistent timeframe for weather data
#filtered weather dataframes
filtered_persb_wx_15min <- persb_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  #removed UTM column
  select(-TIMESTAMP)

filtered_persub_wx_15min <- persub_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  #removed UTM column
  select(-TIMESTAMP)
  
filtered_transb_wx_15min <- transb_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_transun_wx_15min <- transub_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time)
```

# Tree Temp Comparison

```{r}
#adding in a burn status column to the aspect dataframes
filtered_pers_b_aspects <- filtered_pers_b_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "gb") ~ "green burn",
    startsWith(tree_name, "db") ~ "dead burn",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "persistent")

filtered_pers_ub_aspects <- filtered_pers_ub_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "ub") ~ "alive",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "persistent")

filtered_trans_b_aspects <- filtered_trans_b_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "gb") ~ "green burn",
    startsWith(tree_name, "db") ~ "dead burn",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "transitional")

filtered_trans_ub_aspects <- filtered_trans_ub_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "ub") ~ "alive",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  mutate(zone = "transitional")
```

## Differencing Dead burn and Green burn trees

### Persistent Zone

```{r}
#creating a dataframe with green burn temp minus dead burn temp for the same aspects
##north aspect
persb_north_diff_data <- filtered_pers_b_aspects %>%
  # Filter for north aspect
  filter(aspect == 'north') %>%
  # Filter out gb_w tree
  filter(tree_name != 'gb_w') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    gb_e_minus_db_s = mean(temp[tree_name == 'gb_e']) - mean(temp[tree_name == 'db_s']),
    gb_s_minus_db_s = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_s']),
    gb_e_minus_db_n = mean(temp[tree_name == 'gb_e']) - mean(temp[tree_name == 'db_n']),
    gb_s_minus_db_n = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_n'])
  ) %>%
  ungroup()

# Reshape data to long format
persb_north_diff_long <- persb_north_diff_data %>%
  pivot_longer(cols = starts_with("gb"), names_to = "comparison", values_to = "difference") %>%
  #adding in a zone and a burn status for later dataframe combinations
  mutate(burn_status = "burned") %>%
  mutate(zone = "persistent") %>%
  mutate(aspect = "north")

# Plotting the boxplots
persb_north_diff_plot <- ggplot(persb_north_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "North Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(persb_north_diff_plot)
```

```{r}
##south aspect
persb_south_diff_data <- filtered_pers_b_aspects %>%
  # Filter for north aspect
  filter(aspect == 'south') %>%
  # Filter out gb_w tree
  filter(tree_name != 'gb_w') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    gb_e_minus_db_s = mean(temp[tree_name == 'gb_e']) - mean(temp[tree_name == 'db_s']),
    gb_s_minus_db_s = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_s']),
    gb_e_minus_db_n = mean(temp[tree_name == 'gb_e']) - mean(temp[tree_name == 'db_n']),
    gb_s_minus_db_n = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_n'])
  ) %>%
  ungroup()

# Reshape data to long format
persb_south_diff_long <- persb_south_diff_data %>%
  pivot_longer(cols = starts_with("gb"), names_to = "comparison", values_to = "difference") %>%
  #adding in a zone and a burn status for later dataframe combinations
  mutate(burn_status = "burned") %>%
  mutate(zone = "persistent") %>%
  mutate(aspect = "south")

# Plotting the boxplots
persb_south_diff_plot <- ggplot(persb_south_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "South Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(persb_south_diff_plot)
```

```{r}
#combinging north and south plots
persb_combined_aspectdiff_treetemp_plots <- persb_north_diff_plot + persb_south_diff_plot + plot_layout(nrow = 2) + plot_annotation(title = "Persistent Zone, Green & Dead Burn Tree Temp Difference")

persb_combined_aspectdiff_treetemp_plots 

#saving combined plot
ggsave("persb_combined_aspectdiff_treetemp_plots.png", plot = persb_combined_aspectdiff_treetemp_plots , width = 8, height = 10, dpi = 300, bg = "white")

```

### Transitional Zone

```{r}
#creating a dataframe with green burn temp minus dead burn temp for the same aspects
##north aspect
transb_north_diff_data <- filtered_trans_b_aspects %>%
  # Filter for north aspect
  filter(aspect == 'north') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    gb_n_minus_db_s = mean(temp[tree_name == 'gb_n']) - mean(temp[tree_name == 'db_s']),
    gb_s_minus_db_s = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_s']),
    gb_n_minus_db_n = mean(temp[tree_name == 'gb_n']) - mean(temp[tree_name == 'db_n']),
    gb_s_minus_db_n = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_n'])
  ) %>%
  ungroup()

# Reshape data to long format
transb_north_diff_long <- transb_north_diff_data %>%
  pivot_longer(cols = starts_with("gb"), names_to = "comparison", values_to = "difference") %>%
  #adding in a zone and a burn status for later dataframe combinations
  mutate(burn_status = "burned") %>%
  mutate(zone = "transitional") %>%
  mutate(aspect = "north")

# Plotting the boxplots
transb_north_diff_plot <- ggplot(transb_north_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "North Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(transb_north_diff_plot)
```

```{r}
##south aspect
transb_south_diff_data <- filtered_trans_b_aspects %>%
  # Filter for north aspect
  filter(aspect == 'south') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    gb_n_minus_db_s = mean(temp[tree_name == 'gb_n']) - mean(temp[tree_name == 'db_s']),
    gb_s_minus_db_s = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_s']),
    gb_n_minus_db_n = mean(temp[tree_name == 'gb_n']) - mean(temp[tree_name == 'db_n']),
    gb_s_minus_db_n = mean(temp[tree_name == 'gb_s']) - mean(temp[tree_name == 'db_n'])
  ) %>%
  ungroup()

# Reshape data to long format
transb_south_diff_long <- transb_south_diff_data %>%
  pivot_longer(cols = starts_with("gb"), names_to = "comparison", values_to = "difference") %>%
  #adding in a zone and a burn status for later dataframe combinations
  mutate(burn_status = "burned") %>%
  mutate(zone = "transitional") %>%
  mutate(aspect = "south")

# Plotting the boxplots
transb_south_diff_plot <- ggplot(transb_south_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "South Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(transb_south_diff_plot)
```

```{r}
#combinging north and south plots
transb_combined_aspectdiff_treetemp_plots <- transb_north_diff_plot + transb_south_diff_plot + plot_layout(nrow = 2) + plot_annotation(title = "Transitional Zone, Green & Dead Burn Tree Temp Difference")

transb_combined_aspectdiff_treetemp_plots 

#saving combined plot
ggsave("transb_combined_aspectdiff_treetemp_plots.png", plot = transb_combined_aspectdiff_treetemp_plots , width = 8, height = 10, dpi = 300, bg = "white")
```

```{r}
#creating a combined dataframe for the db-gb comparisons
full_dbgb_comparisons_data <- bind_rows(persb_north_diff_long, persb_south_diff_long, transb_north_diff_long, transb_south_diff_long)
```

## Differencing by Individual Tree Aspect

### Persistent Zone

```{r}
#creating a dataframe for each tree
persb_gb_e_diff_data <- filtered_pers_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'gb_e') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'gb_e')

persb_gb_s_diff_data <- filtered_pers_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'gb_s') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'gb_s')

persb_db_n_diff_data <- filtered_pers_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'db_n') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'db_n')

persb_db_s_diff_data <- filtered_pers_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'db_s') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'db_s')

#creating a combined new dataframe
persb_gbdb_combined_data <- bind_rows(persb_gb_e_diff_data, persb_gb_s_diff_data, persb_db_n_diff_data, persb_db_s_diff_data)
```

```{r}
#plotting persistent north-south tree boxplots
persb_gbdb_diff_plot <- ggplot(persb_gbdb_combined_data, aes(x = comparison, y = difference, fill = treename)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Persistent Zone",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Name")

print(persb_gbdb_diff_plot)
```

### Transitional Zone

```{r}
#creating a dataframe for each tree
transb_gb_n_diff_data <- filtered_trans_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'gb_n') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'gb_n')

transb_gb_s_diff_data <- filtered_trans_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'gb_s') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'gb_s')

transb_db_n_diff_data <- filtered_trans_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'db_n') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'db_n')

transb_db_s_diff_data <- filtered_trans_b_aspects %>%
  # Filter for gb_e tree
  filter(tree_name == 'db_s') %>%
  # Calculate differences by datetime
  group_by(datetime) %>%
  summarise(
    south_minus_north = mean(temp[aspect == 'south']) - mean(temp[aspect == 'north'])) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("south"), names_to = "comparison", values_to = "difference") %>%
  mutate(treename = 'db_s')

#creating a combined new dataframe
transb_gbdb_combined_data <- bind_rows(transb_gb_n_diff_data, transb_gb_s_diff_data, transb_db_n_diff_data, transb_db_s_diff_data)
```

```{r}
#plotting transitional north-south tree boxplots
transb_gbdb_diff_plot <- ggplot(transb_gbdb_combined_data, aes(x = comparison, y = difference, fill = treename)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Transitional Zone",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Name")

print(transb_gbdb_diff_plot)
```

```{r}
#combinging north and south plots
combined_bytree_aspect_treetemp_plots <- persb_gbdb_diff_plot + transb_gbdb_diff_plot + plot_layout(nrow = 1) + plot_annotation(title = "Temperature Differences by Tree - south minus north aspect")

combined_bytree_aspect_treetemp_plots

#saving combined plot
ggsave("combined_bytree_aspect_treetemp_plots.png", plot = combined_bytree_aspect_treetemp_plots , width = 10, height = 6, dpi = 300, bg = "white")
```

```{r}
#creating a full dataframe for both pers and transitional data for later plotting of the south-north comparison

##individually editing pers and trans combined data before combining both dataframes
# Add new column 'burn_status' based on conditions, and new column 'zone' based on location
persb_gbdb_combined_data <- persb_gbdb_combined_data %>%
  mutate(burn_status = case_when(
    startsWith(treename, "gb") ~ "green_burned",
    startsWith(treename, "db") ~ "dead_burned",
    TRUE ~ NA_character_  # Handle other cases if needed
  )) %>%
  mutate(zone = "persistent")

transb_gbdb_combined_data <- transb_gbdb_combined_data %>%
  mutate(burn_status = case_when(
    startsWith(treename, "gb") ~ "green_burned",
    startsWith(treename, "db") ~ "dead_burned",
    TRUE ~ NA_character_  # Handle other cases if needed
  )) %>%
  mutate(zone = "transitional")

#creating a full combined dataset
full_southnorth_comparison_data <- bind_rows(persb_gbdb_combined_data, transb_gbdb_combined_data)
```

**Interpretation of box plots**

-   Consistent Boxes: Similar boxes indicate that the general trend and variability within the middle 50% of the data are consistent across different aspects.

-   Many Outliers: The numerous outliers highlight that there are frequent instances of temperature differences that are much higher or lower than the typical range. This could point to specific factors or conditions that cause these deviations.

# Calculating Statistics between gb/db and north/south

```{r}
#creating a combined new dataframe from original dataframes with individual tree temps - May not want a full combined dataset!
full_burned_combined_data <- bind_rows(filtered_pers_b_aspects, filtered_trans_b_aspects)

full_unburned_combined_data <- bind_rows(filtered_pers_ub_aspects, filtered_trans_ub_aspects)
```

```{r}
#exporting important dataframes to N-Drive. These are what are used for stats calculations
write_csv(full_burned_combined_data, "nsf/treetemp_data/full_burned_combined_data.csv")

write_csv(full_unburned_combined_data, "nsf/treetemp_data/full_unburned_combined_data.csv")
```

## Persb - S/N aspect percent difference

Creating a clean dataframe with columns for north and south temps, instead of rows (wide format)

```{r}
#persistent burned 

full_pers_ns_data <- full_burned_combined_data %>%
  filter(!(aspect %in% c("charred", "uncharred"))) %>%
  filter(zone == "persistent") %>%
  #remove gb_w tree, so there is two gb and two db
  filter(!(tree_name == "gb_w"))


clean_persb_ns_temps <- full_pers_ns_data %>%
  group_by(datetime, tree_name, burn_status, zone) %>%
  pivot_wider(names_from = aspect, values_from = temp) %>%
  rename(north_temp = north, south_temp = south) %>%
  summarize(north_temp, south_temp)

##creatinging individual dataframes for north and south temps, then going to rebind them to get rid of the NA issues
north_persb_temps <- clean_persb_ns_temps %>%
  select(-south_temp) %>%
  filter(!is.na(north_temp))# Filter out rows with NA

south_persb_temps <- clean_persb_ns_temps %>%
  select(-north_temp) %>%
  filter(!is.na(south_temp))

##joining north/south dataframes
final_persb_ns_temps <- north_persb_temps %>%
  inner_join(south_persb_temps)
```

```{r}
#calculating statistics
##temp difference

# Compute the overall mean and standard deviation of temp_diff
mean_diff <- mean(final_persb_ns_temps$south_temp - final_persb_ns_temps$north_temp, na.rm = TRUE)

sd_diff <- sd(final_persb_ns_temps$south_temp - final_persb_ns_temps$north_temp, na.rm = TRUE)


# Add new columns to the dataframe
final_persb_ns_temps <- final_persb_ns_temps %>%
  mutate(
    avg_temp = (south_temp + north_temp) / 2,
    temp_diff = south_temp - north_temp,
    percent_diff = abs(100 * temp_diff / avg_temp),
    avg_diff = mean_diff,
    coeff_var = (sd_diff / abs(mean_diff)) * 100
  ) 
  #percent difference - absolute difference (no negatives)
  #calculating the avg (mean) temp
```

Creating a daily dataframe and analysis

```{r}
# Convert timestamp to Date if not already done
final_persb_ns_temps <- final_persb_ns_temps %>%
  mutate(date = as.Date(datetime))

#aggregate data
daily_persb_ns_avg <- final_persb_ns_temps %>%
  group_by(date) %>%
  summarize(
    avg_south_temp = mean(south_temp, na.rm = TRUE),
    avg_north_temp = mean(north_temp, na.rm = TRUE),
    avg_temp = mean(avg_temp, na.rm = TRUE),  # Assuming avg_temp is already calculated
    avg_diff = mean(temp_diff, na.rm = TRUE),  # Assuming mean_diff is already calculated
    percent_diff = mean(percent_diff, na.rm = TRUE),
    coeff_var = mean(coeff_var, na.rm = TRUE)  # Assuming sd_diff and mean_diff are already calculated
    # Add other columns as needed
  ) %>%
  #getting rid of the one date that coinsidentaly had a 0 for the avg diff, therefore an lnf for the percent_diff column
  filter(date != as.Date("2024-05-15"))
```

Creating a monthly dataframe and analysis

```{r}
# Convert datetime to Date if not already done
final_persb_ns_temps <- final_persb_ns_temps %>%
  mutate(month = format(datetime, "%Y-%m"))

# Calculate monthly averages for all columns
monthly_persb_ns_avg <- final_persb_ns_temps %>%
  #getting rid of the one date that coinsidentaly had a 0 for the avg diff, therefore an lnf for the percent_diff column
  filter(date != as.Date("2024-05-15")) %>%
  group_by(month) %>%
  summarize(
    avg_south_temp = mean(south_temp, na.rm = TRUE),
    avg_north_temp = mean(north_temp, na.rm = TRUE),
    avg_temp = mean(avg_temp, na.rm = TRUE),  # Assuming avg_temp is already calculated
    avg_diff = mean(temp_diff, na.rm = TRUE),  # Assuming mean_diff is already calculated
    percent_diff = mean(percent_diff, na.rm = TRUE),
    coeff_var = mean(coeff_var, na.rm = TRUE)  # Assuming sd_diff and mean_diff are already calculated
    # Add other columns as needed
  ) %>%
  mutate(zone = "persistent")
```

```{r}
#exporting important dataframes for use later
write_csv(final_persb_ns_temps, "nsf/105E_pers_burned/final_persb_ns_temps.csv")

write_csv(monthly_persb_ns_avg, "nsf/105E_pers_burned/monthly_persb_ns_avg.csv")
```

## Pers ub - S/N aspect

```{r}
#persistent unburned final dataset
full_pers_ub_ns_data <- full_unburned_combined_data %>%
  mutate(burn_status = "unburned") %>%
  filter(zone == "persistent")

clean_pers_ub_ns_temps <- full_pers_ub_ns_data %>%
  group_by(datetime, tree_name, burn_status, zone) %>%
  pivot_wider(names_from = aspect, values_from = temp) %>%
  rename(north_temp = north, south_temp = south) %>%
  summarize(north_temp, south_temp)

##creatinging individual dataframes for north and south temps, then going to rebind them to get rid of the NA issues
north_pers_ub_temps <- clean_pers_ub_ns_temps %>%
  select(-south_temp) %>%
  filter(!is.na(north_temp))# Filter out rows with NA

south_pers_ub_temps <- clean_pers_ub_ns_temps %>%
  select(-north_temp) %>%
  filter(!is.na(south_temp))

##joining north/south dataframes
final_pers_ub_ns_temps <- north_pers_ub_temps %>%
  inner_join(south_pers_ub_temps)
```

## Transb - S/N aspect

```{r}
#transitional burned 

full_trans_ns_data <- full_burned_combined_data %>%
  filter(!(aspect %in% c("charred", "uncharred"))) %>%
  filter(zone == "transitional")

clean_transb_ns_temps <- full_trans_ns_data %>%
  group_by(datetime, tree_name, burn_status, zone) %>%
  pivot_wider(names_from = aspect, values_from = temp) %>%
  rename(north_temp = north, south_temp = south) %>%
  summarize(north_temp, south_temp)

##creatinging individual dataframes for north and south temps, then going to rebind them to get rid of the NA issues
north_transb_temps <- clean_transb_ns_temps %>%
  select(-south_temp) %>%
  filter(!is.na(north_temp))# Filter out rows with NA

south_transb_temps <- clean_transb_ns_temps %>%
  select(-north_temp) %>%
  filter(!is.na(south_temp))

##joining north/south dataframes
final_transb_ns_temps <- north_transb_temps %>%
  inner_join(south_transb_temps)
```

```{r}

# Compute the overall mean and standard deviation of temp_diff
mean_diff <- mean(final_transb_ns_temps$south_temp - final_transb_ns_temps$north_temp, na.rm = TRUE)

sd_diff <- sd(final_transb_ns_temps$south_temp - final_transb_ns_temps$north_temp, na.rm = TRUE)


# Add new columns to the dataframe
final_transb_ns_temps <- final_transb_ns_temps %>%
  mutate(
    avg_temp = (south_temp + north_temp) / 2,
    temp_diff = south_temp - north_temp,
    percent_diff = abs(100 * temp_diff / avg_temp),
    avg_diff = mean_diff,
    coeff_var = (sd_diff / abs(mean_diff)) * 100
  ) 
  #percent difference - absolute difference (no negatives)
  #calculating the avg (mean) temp
```

Creating a daily dataframe

```{r}
# Convert timestamp to Date if not already done
final_transb_ns_temps <- final_transb_ns_temps %>%
  mutate(date = as.Date(datetime))

#aggregate data
daily_transb_ns_avg <- final_transb_ns_temps %>%
  group_by(date) %>%
  summarize(
    avg_south_temp = mean(south_temp, na.rm = TRUE),
    avg_north_temp = mean(north_temp, na.rm = TRUE),
    avg_temp = mean(avg_temp, na.rm = TRUE),  # Assuming avg_temp is already calculated
    avg_diff = mean(temp_diff, na.rm = TRUE),  # Assuming mean_diff is already calculated
    percent_diff = mean(percent_diff, na.rm = TRUE),
    coeff_var = mean(coeff_var, na.rm = TRUE)  # Assuming sd_diff and mean_diff are already calculated
    # Add other columns as needed
  )
```

Creating a monthly dataframe

```{r}
# Convert datetime to Date if not already done
final_transb_ns_temps <- final_transb_ns_temps %>%
  mutate(month = format(datetime, "%Y-%m"))

# Calculate monthly averages for all columns
monthly_transb_ns_avg <- final_transb_ns_temps %>%
  group_by(month) %>%
  summarize(
    avg_south_temp = mean(south_temp, na.rm = TRUE),
    avg_north_temp = mean(north_temp, na.rm = TRUE),
    avg_temp = mean(avg_temp, na.rm = TRUE),  # Assuming avg_temp is already calculated
    avg_diff = mean(temp_diff, na.rm = TRUE),  # Assuming mean_diff is already calculated
    percent_diff = mean(percent_diff, na.rm = TRUE),
    coeff_var = mean(coeff_var, na.rm = TRUE)  # Assuming sd_diff and mean_diff are already calculated
    # Add other columns as needed
  ) %>%
  mutate(zone = "transitional")
```

```{r}
#exporting important dataframes for use later
write_csv(final_transb_ns_temps, "nsf/105E_trans_burned/final_transb_ns_temps.csv")
```

## Trans ub - S/N temps

```{r}
#tranitional unburned final dataset
full_trans_ub_ns_data <- full_unburned_combined_data %>%
  mutate(burn_status = "unburned") %>%
  filter(zone == "transitional")

clean_trans_ub_ns_temps <- full_trans_ub_ns_data %>%
  group_by(datetime, tree_name, burn_status, zone) %>%
  pivot_wider(names_from = aspect, values_from = temp) %>%
  rename(north_temp = north, south_temp = south) %>%
  summarize(north_temp, south_temp)

##creatinging individual dataframes for north and south temps, then going to rebind them to get rid of the NA issues
north_trans_ub_temps <- clean_trans_ub_ns_temps %>%
  select(-south_temp) %>%
  filter(!is.na(north_temp))# Filter out rows with NA

south_trans_ub_temps <- clean_trans_ub_ns_temps %>%
  select(-north_temp) %>%
  filter(!is.na(south_temp))

##joining north/south dataframes
final_trans_ub_ns_temps <- north_trans_ub_temps %>%
  inner_join(south_trans_ub_temps)
```

## Combining burned and unburned dataframes by zone

-   important step

```{r}
#combining persistent and transitional unburned to create a 15min_unburned datatable

final_15min_ns_ub <- bind_rows(final_pers_ub_ns_temps, final_trans_ub_ns_temps) %>%
  #adding in day & month
  mutate(day = as.Date(datetime), month = month(datetime)) %>%
  #adding in mean temp of north and south temps
  mutate(avg_temp = mean((south_temp + north_temp) / 2)) %>%
  mutate(burn_status = "unburned") %>%
  select(datetime, day, month, zone, burn_status, tree_name, everything())
```

```{r}
#combining persistent and transitional burnedto create a 15min_burned datatable

final_15min_ns_b <- bind_rows(final_persb_ns_temps, final_transb_ns_temps) %>%
  #adding in day & month
  mutate(day = as.Date(datetime), month = month(datetime)) %>%
  #adding in mean temp of north and south temps
  mutate(avg_temp = mean((south_temp + north_temp) / 2)) %>%
  select(-date) %>%
  select(datetime, day, month, zone, burn_status, tree_name, everything())
```

```{r}
#writing final n/s combined dataframes to n-drive
write_csv(final_15min_ns_b, "nsf/treetemp_data/final_15min_ns_b.csv")

write_csv(final_15min_ns_ub, "nsf/treetemp_data/final_15min_ns_ub.csv")
```

## Combining Pers and Trans monthly dataframes to make a table:

```{r}
monthly_stats_byzone <- bind_rows(monthly_persb_ns_avg, monthly_transb_ns_avg) %>%
  select(zone, everything())
```

```{r}
#saving the dataframe as an excel spreadsheet
write.xlsx(monthly_stats_byzone, "monthly_stats_byzone.xlsx")
#i dragged the excel sheet from n-drive to personal folder
```

# Cutting timeframe

## Creating day-only dataframes

```{r}
#persistent daytime dataframes
dt_pers_b_aspects <- filtered_pers_b_aspects %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)

dt_pers_ub_aspects <- filtered_pers_ub_aspects %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)

#transitional daytime dataframes
dt_trans_b_aspects <- filtered_trans_b_aspects %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)

dt_trans_ub_aspects <- filtered_trans_ub_aspects %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)
```

## Plotting daytime DB/GB differencing

### Persistent Zone

```{r}
#manipulating the dataset to only be hours between 6 am and 9 pm MST
dt_persb_north_diff_long <- persb_north_diff_long %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)

dt_persb_south_diff_long <- persb_south_diff_long %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)

#plotting
dt_persb_north_diff_plot <- ggplot(dt_persb_north_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Daytime North Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(dt_persb_north_diff_plot)

dt_persb_south_diff_plot <- ggplot(dt_persb_south_diff_long, aes(x = comparison, y = difference, fill = comparison)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Daytime South Aspect",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Comparison")

print(dt_persb_south_diff_plot)
```

## Plotting daytime aspect differencing

### Persistent Zone

```{r}
#creating new dataframe with only daytime hours
dt_persb_gbdb_combined_data <- persb_gbdb_combined_data %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)

#plotting
dt_persb_gbdb_diff_plot <- ggplot(dt_persb_gbdb_combined_data, aes(x = comparison, y = difference, fill = treename)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Daytime Persistent Zone",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Name")

print(dt_persb_gbdb_diff_plot)
```

Transitional Zone

```{r}
#creating new dataframe with only daytime hours
dt_transb_gbdb_combined_data <- transb_gbdb_combined_data %>%
  filter(hour(datetime) >= 6 & hour(datetime) <= 21)

#plotting
dt_transb_gbdb_diff_plot <- ggplot(dt_transb_gbdb_combined_data, aes(x = comparison, y = difference, fill = treename)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Daytime Transitional Zone",
       x = "Comparison",
       y = "Temperature Difference (°C)",
       fill = "Tree Name")

print(dt_transb_gbdb_diff_plot)
```

# Understanding the Statistics

When you calculate an average difference between two temperatures and analyze the percent difference, average, and coefficient of variation, each metric provides different insights into your data:

1.  **Percent Difference**:

    -   **What it tells you**: The percent difference gives you a relative measure of the difference between the two temperatures compared to their average. It tells you how large the difference is in relation to the overall magnitude of the temperatures.

    -   **Interpretation**: A high percent difference indicates a significant discrepancy between the two temperatures, whereas a low percent difference suggests that the temperatures are relatively similar.

2.  **Average**:

    -   **What it tells you**: The average temperature difference provides a measure of the central tendency of the differences between the two temperatures. It is the mean value of all the calculated differences.

    -   **Interpretation**: This metric gives you an idea of the typical or expected difference between the temperatures. It is useful for understanding the overall trend in the temperature differences.

3.  **Coefficient of Variation (CV)**:

    -   **What it tells you**: The coefficient of variation is a standardized measure of dispersion of the temperature differences. It is calculated as the ratio of the standard deviation to the mean and is usually expressed as a percentage.

    -   **Interpretation**: A high CV indicates that the temperature differences are highly variable, suggesting inconsistency or high variability in the temperature differences. A low CV indicates that the temperature differences are relatively consistent and stable.

### Example Scenario

Suppose you have two sets of temperature readings (in °C) from two different sensors or locations. After calculating the differences between the corresponding readings, you obtain the following statistics:

-   **Average Difference**: 2°C

-   **Percent Difference**: 10%

-   **Coefficient of Variation**: 25%

#### Interpretation:

-   **Average Difference**: On average, there is a 2°C difference between the temperatures recorded by the two sensors or at the two locations.

-   **Percent Difference**: The 10% difference indicates that the temperature difference is relatively small compared to the average temperature values of the readings.

-   **Coefficient of Variation**: A CV of 25% suggests moderate variability in the temperature differences. While there is some fluctuation in the differences, it is not extremely high, indicating that the differences are somewhat consistent but not entirely uniform.

In summary, these metrics together help you understand the magnitude, relative size, and variability of the temperature differences in your data.

## My Understanding of the Data

-   very high coefficient of variation and percent differences mean that there is a lot of variability of temperatures, even on a daily and monthly scale.

------------------------------------------------------------------------

# Calculating Statistics for Day vs Night Temp Differences

## Calling in Data

```{r}
#dataframe with single mean daily values calculated for daytime and nighttime, averaging not between N/S but for all trees.
single_avg_all_treetemps <- read_excel("nsf/single_avg_all_treetemps.xlsx")
```

```{r}
#manipulating dataframe to run stats on
stats_single_avg_all_treetemps <- single_avg_all_treetemps %>%
  group_by(date, phase, burn_status, zone) %>%
  pivot_wider(names_from = phase, values_from = avg_temp) %>%
  rename(avg_day_temp = day, avg_night_temp = night) %>%
  reframe(avg_day_temp, avg_night_temp)
  
##creatinging individual dataframes for day and night temps, then going to rebind them to get rid of the NA issues
day_all_temps <- stats_single_avg_all_treetemps %>%
  select(-avg_night_temp) %>%
  filter(!is.na(avg_day_temp))# Filter out rows with NA

night_all_temps <- stats_single_avg_all_treetemps %>%
  select(-avg_day_temp) %>%
  filter(!is.na(avg_night_temp))

##joining north/south dataframes
final_single_avg_all_treetemps <- day_all_temps %>%
  inner_join(night_all_temps) %>%
  #adding in week and month columns
  mutate(
    month = format(date, "%Y-%m"),
    week = week(date)  # Extract week number from datetime
  ) %>%
  #adding in statistics calculations
  mutate(
    avg_temp = (avg_day_temp + avg_night_temp) / 2,
    temp_diff = avg_day_temp - avg_night_temp,
    percent_diff = abs(100 * temp_diff / avg_temp),
    avg_diff = mean_diff,
    coeff_var = (sd_diff / abs(mean_diff)) * 100
  ) 
```

## Calculating Statistics

```{r}
#calculating weekly single avg stats
weekly_single_avg_temps <- final_single_avg_all_treetemps %>%
  group_by(burn_status, zone, month, week) %>%
  summarize(
    avg_day_temp = mean(avg_day_temp, na.rm = TRUE),
    avg_night_temp = mean(avg_night_temp, na.rm = TRUE),
    avg_temp = mean(avg_temp, na.rm = TRUE),  # Assuming avg_temp is already calculated
    avg_diff = mean(temp_diff, na.rm = TRUE),  # Assuming temp_diff is already calculated
    percent_diff = mean(percent_diff, na.rm = TRUE),
    coeff_var = mean(coeff_var, na.rm = TRUE)  # Assuming coeff_var is already calculated
    # Add other columns as needed
  )
```

```{r}
#creating monthly single avg stats
monthly_single_avg_temps <- final_single_avg_all_treetemps %>%
  group_by(burn_status, zone, month) %>%
  summarize(
    avg_day_temp = mean(avg_day_temp, na.rm = TRUE),
    avg_night_temp = mean(avg_night_temp, na.rm = TRUE),
    avg_temp = mean(avg_temp, na.rm = TRUE),  # Assuming avg_temp is already calculated
    avg_diff = mean(temp_diff, na.rm = TRUE),  # Assuming temp_diff is already calculated
    percent_diff = mean(percent_diff, na.rm = TRUE),
    coeff_var = mean(coeff_var, na.rm = TRUE)  # Assuming coeff_var is already calculated
    # Add other columns as needed
  )
```

### Exporting Tables

```{r}
##this step is not working, not sure why?!
#saving the dataframe as an excel spreadsheet
write.xlsx(monthly_single_avg_temps, "nsf/monthly_single_avg_temps.xlsx")

write.xlsx(weekly_single_avg_temps, "nsf/weekly_single_avg_temps.xlsx")
```

# Exporting all Stats to Tables

```{r}
#single daily average, day/night comparison - monthly table
write_csv(monthly_single_avg_temps, "nsf/monthly_single_avg_temps.csv")

#single daily average, day/night comparison - weekly table
write_csv(weekly_single_avg_temps, "nsf/weekly_single_avg_temps.csv")
```
