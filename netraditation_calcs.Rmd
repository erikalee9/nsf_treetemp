---
title: "netradiation_calcs"
author: "Erika Lee"
date: "2024-07-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lterdatasampler)
library(dplyr)
library(ggplot2)
library(readr)
library(readxl)
library(lubridate)
library(plotly)
library(openxlsx)
library(plotly)
library(rstatix)
library(htmlwidgets)
library(RColorBrewer)
library(patchwork)
#package for scientific notation of numbers
library(scales)

setwd("/Volumes/wcnr-network/Research/Kampf/Private/field_data")
```

# Calling in Data

```{r}
#calling in weather station data from n-drive
##persistent zone
persb_wx_15min <- read_excel("nsf/pers_burned/pers_burned_wx_15min_r.xlsx")

persub_wx_15min <- read_excel("nsf/pers_unburned/pers_unburned_wx_15min_composite.xlsx")

##transitional
transb_wx_15min <- read_excel("nsf/trans_burned/trans_burned_wx_15min_r.xlsx")

transub_wx_15min <- read_excel("nsf/trans_unburned/trans_unburned_wx_15min_r.xlsx")
```

```{r}
#calling in tree temp data from n-drive
## burned
pers_b_aspects <- read_excel("nsf/105E_pers_burned/105E_pers_b_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

trans_b_aspects <- read_excel("nsf/105E_trans_burned/105E_trans_b_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

##unburned
pers_ub_aspects <- read_excel("nsf/105E_pers_unburned/105E_pers_ub_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

trans_ub_aspects <- read_excel("nsf/105E_trans_unburned/105E_trans_ub_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))
```

```{r}
#setting a consistent timeframe for all tree temp data for all burned/unburned zones
##has to start at 2024-02-02 due to errors in data at transitional burned site

#tree temp dataframes
start_time <- ymd_hms("2024-02-02 00:00:00")
end_time <- ymd_hms("2024-05-24 00:00:00")

filtered_pers_b_aspects <- pers_b_aspects %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  #adding in column for site name, for when combining dataframes
  mutate(site = "pers_burned") %>%
  mutate(tree_circ_m = '')

filtered_pers_ub_aspects <- pers_ub_aspects %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  mutate(site = "pers_unburned")

filtered_trans_b_aspects <- trans_b_aspects %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  mutate(site = "trans_burned")

filtered_trans_ub_aspects <- trans_ub_aspects %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  mutate(site = "trans_unburned")
```

```{r}
#creating one compiled dataframe that has all tree temps in it

all_treetemps <- bind_rows(filtered_pers_b_aspects, filtered_pers_ub_aspects, filtered_trans_b_aspects, filtered_trans_ub_aspects)
```

# RL for trees Calculations

Create a 15 min Rl(in) calculation for trees based on the tree temp

```{r}
# Constants
stefan_boltzmann_constant <- 5.67e-8
emissivity <- 0.97
#wedll depth and circumference are in meters
welldepth <- 1
circumference <- 0.40
#average circumference of a lodgepole is ~ 16 inches = 0.40 meters
#picking an average unit depth for well depth of 1 meter

#constant for m2 
m2 = welldepth*circumference

# Define the time interval (15 minutes in seconds)
time_interval_seconds <- 15 * 60

# Calculate incoming longwave radiation and add to dataframe
all_treetemps <- all_treetemps %>%
  #add a date column for calculations later
  mutate(date = as_date(datetime)) %>%
  mutate(
    temp_k= temp + 273.15, # Convert temperature to Kelvin
    tree_RL_in = emissivity * stefan_boltzmann_constant * (temp_k^4) # Calculate longwave radiation
  ) %>%
#the RL_in units are W/m2, the m2 component is 
  #calculating watz (W)
  #W is = to J/s
  mutate(W = tree_RL_in*m2) %>%
  # Convert instantaneous power (W) to energy (J) for each 15-minute interval
  mutate(energy_J = W * time_interval_seconds)
```

```{r}
# Aggregate energy (J) to get daily total energy in Joules
daily_energy_J <- all_treetemps %>%
  group_by(date) %>%
  summarize(daily_energy_J = sum(energy_J, na.rm = TRUE))

# Display the resulting dataframe with scientific notation
daily_energy_J <- daily_energy_J %>%
  mutate(daily_energy_J_sci = scientific(daily_energy_J))
```
