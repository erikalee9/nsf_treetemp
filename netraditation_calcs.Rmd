---
title: "netradiation_calcs"
author: "Erika Lee"
date: "2024-07-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lterdatasampler)
library(dplyr)
library(ggplot2)
library(readr)
library(readxl)
library(lubridate)
library(plotly)
library(openxlsx)
library(plotly)
library(rstatix)
library(htmlwidgets)
library(RColorBrewer)
library(patchwork)
#package for scientific notation of numbers
library(scales)

setwd("/Volumes/wcnr-network/Research/Kampf/Private/field_data")
```

# Color Set Up

```{r}
#to display the colors
display.brewer.pal(n = 8, name = "Dark2")

#to get the hex number of the colors
brewer.pal(n = 8, name = "Dark2")
```

```{r}
#setting a color-blind friendly custom palette for gb/db/ubn- using RColorBrewer
##blue is unburned, orange is dead burned, green is green burned
three_custom_colors <- c("#D95F02","#1B7837", "#2166AC")

## orange is burned, blue is unburned
two_custom_colors <- c("#D95F02", "#2166AC")
```

```{r}
#to display the colors
display.brewer.pal(n = 8, name = "YlOrRd")

#to get the hex number of the colors
brewer.pal(n = 8, name = "YlOrRd")

#first color is incoming R, second color is outgoing R
solar_rad_colors <- c("#B10026", "#FD8D3C")
```

# Calling in Data

```{r}
#calling in weather station data from n-drive
##persistent zone
persb_wx_15min <- read_excel("nsf/pers_burned/pers_burned_wx_15min_r.xlsx")

persub_wx_15min <- read_excel("nsf/pers_unburned/pers_unburned_wx_15min_r.xlsx")

##transitional
transb_wx_15min <- read_excel("nsf/trans_burned/trans_burned_wx_15min_r.xlsx")

transub_wx_15min <- read_excel("nsf/trans_unburned/trans_unburned_wx_15min_r.xlsx")
```

```{r}
#calling in tree temp data from n-drive
## burned
pers_b_aspects <- read_excel("nsf/105E_pers_burned/105E_pers_b_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

trans_b_aspects <- read_excel("nsf/105E_trans_burned/105E_trans_b_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

##unburned
pers_ub_aspects <- read_excel("nsf/105E_pers_unburned/105E_pers_ub_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))

trans_ub_aspects <- read_excel("nsf/105E_trans_unburned/105E_trans_ub_aspects.xlsx") %>%
  mutate(datetime = ymd_hms(datetime))
```

Setting Constants

```{r}

#tree temp dataframes
start_time <- ymd_hms("2024-02-02 00:00:00")
end_time <- ymd_hms("2024-05-24 00:00:00")
#2nd end time is for weather staion/ radiation data, as persistent burned weather data only goes to 4-22-2024
end_time_2 <- ymd_hms("2024-04-21 00:00:00")

#setting a day and night time 
daytime <- hms("08:30:00")
nighttime <- hms("17:30:00")
```

```{r}
#filtering temp data
filtered_pers_b_aspects <- pers_b_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_pers_ub_aspects <- pers_ub_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_trans_b_aspects <- trans_b_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_trans_ub_aspects <- trans_ub_aspects %>%
  filter(datetime >= start_time & datetime <= end_time)
```

```{r}
#setting a consistent timeframe for all tree temp data for all burned/unburned zones
##has to start at 2024-02-02 due to errors in data at transitional burned site

#adding in a burn status column to the aspect dataframes
filtered_pers_b_aspects <- filtered_pers_b_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "gb") ~ "green burn",
    startsWith(tree_name, "db") ~ "dead burn",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "persistent")

filtered_pers_ub_aspects <- filtered_pers_ub_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "ub") ~ "unburned",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "persistent")

filtered_trans_b_aspects <- filtered_trans_b_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "gb") ~ "green burn",
    startsWith(tree_name, "db") ~ "dead burn",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "transitional")

filtered_trans_ub_aspects <- filtered_trans_ub_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "ub") ~ "unburned",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  mutate(zone = "transitional")
```

```{r}
#creating one compiled dataframe that has all tree temps in it for all trees, not just an average

all_treetemps <- bind_rows(filtered_pers_b_aspects, filtered_pers_ub_aspects, filtered_trans_b_aspects, filtered_trans_ub_aspects)
```

# RL for trees Calculations

Create a 15 min LWout calculation for trees based on the tree temp

```{r}
# Constants
stefan_boltzmann_constant <- 5.67e-8
emissivity <- 0.97
#wedll depth and circumference are in meters
welldepth <- 1
circumference <- 0.40
#average circumference of a lodgepole is ~ 16 inches = 0.40 meters
#picking an average unit depth for well depth of 1 meter

#constant for m2 
m2 = welldepth*circumference

# Define the time interval (15 minutes in seconds)
time_interval_seconds <- 15 * 60

# Calculate incoming longwave radiation and add to dataframe
all_treetemps <- all_treetemps %>%
  #add a date column for calculations later
  mutate(date = as_date(datetime)) %>%
  mutate(
    temp_k= temp + 273.15, # Convert temperature to Kelvin
    tree_RL_out = emissivity * stefan_boltzmann_constant * (temp_k^4) # Calculate longwave radiation
  ) %>%
#the RL_in units are W/m2, the m2 component is 
  #calculating watz (W)
  #W is = to J/s
  mutate(W = tree_RL_out*m2) %>%
  # Convert instantaneous power (W) to energy (J) for each 15-minute interval
  mutate(energy_J = W * time_interval_seconds) %>%
  #adding in a time column for day/night parsing later
  mutate(time = hms(format(datetime, "%H:%M:%S"))) %>%
  select(-sensor_id) %>%
  select(datetime, date, time, everything())
```

Southern temp tree average - averaging all the gb/db/ub trees instead of analyzing each individual tree

```{r}
#creating a dataframe that is the average of the tree temps by burn_status and zone, only southern temps.
avg_s_all_treetemps <- all_treetemps %>%
  filter(aspect == "south") %>%
  group_by(datetime, zone, burn_status) %>%
  # This step gets the mean of all the south aspect tree temps by zone and burn_status
  summarize(
    temp = mean(temp, na.rm = TRUE), 
    temp_k = mean(temp_k, na.rm = TRUE), 
    tree_LWout_wperm2 = mean(tree_RL_out, na.rm = TRUE), 
    W = mean(W, na.rm = TRUE), 
    energy_J = mean(energy_J, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  # Adding in a date, time, and phase columns for day/night parsing later
  mutate(
    # Extract the date part
    date = date(datetime),
    # Extract the time part
    time = format(datetime, "%H:%M:%S"),
    # Convert time, daytime, and nighttime to POSIXct for comparison
    time = hms(time),
    daytime = hms(daytime),
    nighttime = hms(nighttime)
  ) %>%
  mutate(phase = case_when(
    time >= daytime & time < nighttime ~ "day",
    time < daytime | time >= nighttime ~ "night",
    TRUE ~ NA_character_  # Handle cases where none of the conditions match
  )) %>%
  select(c(-daytime, -nighttime)) %>%
  #adding in a MJ conversion
  mutate(energy_MJ = energy_J / 1e6) %>%
  select(datetime, date, time, phase, everything()) %>%
  mutate(time = format(time, "%H:%M:%S"))
```

```{r}
#creating a daily energy dataframe for the trees LWout values (w/m2 and MJ) - to be used later with the weather station radiation components and plotting!
s_daily_avg_tree_e <- avg_s_all_treetemps %>%
  select(datetime, date, time, phase, zone, burn_status, tree_LWout_wperm2, energy_MJ) %>%
  #grouping to get daily average
  group_by(date, phase, burn_status, zone) %>%
  summarize(tree_LWout_avg_wperm2 = mean(tree_LWout_wperm2, na.rm = TRUE), tree_LWout_avg_MJ = mean(energy_MJ, na.rm = TRUE))
```

# Day/Night Plots

## Max Daynight Plots

\*\* Don't think I need any of these dtnt dataframes, as I already added the "phase" to my main dataframe and I can facet wrap from there?

```{r}
#parsing out daytime/nightime dataframe - MAX RLout
dtnt_max_energy_bysite <- average_daily_energy_by_site %>%
  #adding in a day/night column to facet wrap later
  mutate(phase = case_when(
    time >= daytime & time <= nighttime ~ "day",
    time <= daytime | time >= nighttime ~ "night",
    TRUE ~ NA_character_  # If none of the conditions match, handle accordingly
  )) %>%
  group_by(date, phase, burn_status, zone) %>%
  summarize(daily_max_energy_MJ = max(average_energy_MJ, na.rm = TRUE))
```

```{r}
#plotting daytime/nighttime plot
dtnt_max_energy_plot <- ggplot(dtnt_max_energy_bysite, aes(x = date, y = daily_max_energy_MJ, color = burn_status, linetype = zone)) +
  geom_line() +   # Add lines
  labs(title = "Maximum LWout from trees by day/night",
       x = "Date",
       y = "Max LW out (MJ)",
       color = "Burn Status",
       linetype = "Zone") +
  theme_minimal() +
  facet_wrap(~ phase) +
  scale_color_manual(values = two_custom_colors)

dtnt_max_energy_plot
```

```{r}
#facet wrapping the above plot by both zone and day/night, to see if the plot makes more sens

dtnt_max_energy_plot_V2 <- ggplot(dtnt_max_energy_bysite, aes(x = date, y = daily_max_energy_MJ, color = burn_status)) +
  geom_line() +   # Add lines
  labs(title = "Maximum LWout from trees by day/night",
       x = "Date",
       y = "Max LW out (MJ)",
       color = "Burn Status") +
  theme_minimal() +
  facet_wrap(~zone + phase, dir = "v") +
    scale_color_manual(values = two_custom_colors)

dtnt_max_energy_plot_V2
```

```{r}
#converting to a plotly
plotly_dtnt_max_energy <- ggplotly(dtnt_max_energy_plot)

plotly_dtnt_max_energy
```

```{r}
#saving ggplot
ggsave("dtnt_max_RLout_plot.png", plot = dtnt_max_energy_plot, width = 10, height = 6, dpi = 300, bg = "white")


#saving plotly as a html website link
htmlwidgets::saveWidget(plotly_dtnt_max_energy, "plotly_dtnt_max_RLout.html")
```

## Avg Daynight Plots

```{r}
#parsing out daytime/nightime dataframe - AVG RLout
dtnt_avg_energy_bysite <- average_daily_energy_by_site %>%
  #adding in a day/night column to facet wrap later
  mutate(phase = case_when(
    time >= daytime & time <= nighttime ~ "day",
    time <= daytime | time >= nighttime ~ "night",
    TRUE ~ NA_character_  # If none of the conditions match, handle accordingly
  )) %>%
  group_by(date, phase, burn_status, zone) %>%
  summarize(daily_avg_energy_MJ = mean(average_energy_MJ, na.rm = TRUE))
```

```{r}
#new plot, facet wrapped by zone and phase
dtnt_avg_energy_plot_V2 <- ggplot(dtnt_avg_energy_bysite, aes(x = date, y = daily_avg_energy_MJ, color = burn_status)) +
  geom_line() +   # Add lines
  labs(title = "Average LWout from trees by day/night",
       x = "Date",
       y = "Avg LW out (MJ)",
       color = "Burn Status") +
  theme_minimal() +
  facet_wrap(~ zone + phase, dir = "v") +
  scale_color_manual(values = two_custom_colors)

dtnt_avg_energy_plot_V2
```

```{r}
#converting to a plotly
plotly_dtnt_avg_energy <- ggplotly(dtnt_avg_energy_plot)

plotly_dtnt_avg_energy
```

```{r}
#saving ggplot
ggsave("dtnt_avg_RLout_plot.png", plot = dtnt_avg_energy_plot, width = 10, height = 6, dpi = 300, bg = "white")


#saving plotly as a html website link
htmlwidgets::saveWidget(plotly_dtnt_avg_energy, "plotly_dtnt_avg_RLout.html")
```

# Final Day/Night Plots

NEW PLOTS - from 2024.07.24, with simple dataframe reference

```{r}
#MJ plot
s_dtnt_avg_e_MJ_plot <- ggplot(s_daily_avg_tree_e, aes(x = date, y = tree_LWout_avg_MJ, color = burn_status)) +
  geom_line() +   # Add lines
  labs(title = "South Aspect Daily Avg LWout (MJ) from trees by day/night",
       x = "Date",
       y = "Avg LW out (MJ)",
       color = "Burn Status") +
  theme_minimal() +
  facet_wrap(~ zone + phase, dir = "v") +
  scale_color_manual(values = three_custom_colors)

s_dtnt_avg_e_MJ_plot
```

```{r}
#w per m2 plot
s_dtnt_avg_e_wperm2_plot <- ggplot(s_daily_avg_tree_e, aes(x = date, y = tree_LWout_avg_wperm2, color = burn_status)) +
  geom_line() +   # Add lines
  labs(title = "South Aspect Daily Avg LWout (W/m2) from trees by day/night",
       x = "Date",
       y = "Avg LW out (W/m2)",
       color = "Burn Status") +
  theme_minimal() +
  facet_wrap(~ zone + phase, dir = "v") +
  scale_color_manual(values = three_custom_colors)

s_dtnt_avg_e_wperm2_plot
```

as of 2024.07.24 - keep working on what's below this point, need to reference main "s_daily_avg_tree_e" dataframe as much as possible, and make a simple combined dataframe where applicable. Also need to convert radiative components from wx station into MJ.

# Tree RL + Weather Station Data

## Data Wrangling

### Weather station data

```{r}
#filtered weather station data
filtered_pers_b_wx <- persb_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time_2) %>%
  mutate(zone = "persistent") %>%
  mutate(burn_status = "burned") %>%
  mutate(date = as_date(datetime),time = format(datetime, "%H:%M:%S"))%>%
  select(c(datetime, date, time, zone, burn_status, SWin_Avg, SWout_Avg, LWin_Avg, LWout_Avg))

filtered_pers_ub_wx <- persub_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time_2) %>%
  mutate(zone = "persistent") %>%
  mutate(burn_status = "unburned") %>%
  mutate(date = as_date(datetime),time = format(datetime, "%H:%M:%S")) %>%
  select(c(datetime, date, time, zone, burn_status, SWin_Avg, SWout_Avg, LWin_Avg, LWout_Avg))

filtered_trans_b_wx <- transb_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time_2) %>%
  mutate(zone = "transitional") %>%
  mutate(burn_status = "burned") %>%
  mutate(date = as_date(datetime),time = format(datetime, "%H:%M:%S"))%>%
  select(c(datetime, date, time, zone, burn_status, SWin_Avg, SWout_Avg, LWin_Avg, LWout_Avg))

filtered_trans_ub_wx <- transub_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time_2) %>%
  mutate(zone = "transitional") %>%
  mutate(burn_status = "unburned") %>%
  mutate(date = as_date(datetime),time = format(datetime, "%H:%M:%S"))%>%
  select(c(datetime, date, time, zone, burn_status, SWin_Avg, SWout_Avg, LWin_Avg, LWout_Avg))

#ensuring that the values are numeric for all columns
# Ensure all joining columns have the same type across all dataframes
filtered_pers_b_wx <- filtered_pers_b_wx %>%
  mutate(
    SWin_Avg = as.numeric(SWin_Avg),
    SWout_Avg = as.numeric(SWout_Avg),
    LWin_Avg = as.numeric(LWin_Avg),
    LWout_Avg = as.numeric(LWout_Avg)
  )

filtered_pers_ub_wx <- filtered_pers_ub_wx %>%
  mutate(
    SWin_Avg = as.numeric(SWin_Avg),
    SWout_Avg = as.numeric(SWout_Avg),
    LWin_Avg = as.numeric(LWin_Avg),
    LWout_Avg = as.numeric(LWout_Avg)
  ) 

filtered_trans_b_wx <- filtered_trans_b_wx %>%
  mutate(
    SWin_Avg = as.numeric(SWin_Avg),
    SWout_Avg = as.numeric(SWout_Avg),
    LWin_Avg = as.numeric(LWin_Avg),
    LWout_Avg = as.numeric(LWout_Avg)
  )

filtered_trans_ub_wx <- filtered_trans_ub_wx %>%
  mutate(
    SWin_Avg = as.numeric(SWin_Avg),
    SWout_Avg = as.numeric(SWout_Avg),
    LWin_Avg = as.numeric(LWin_Avg),
    LWout_Avg = as.numeric(LWout_Avg)
  )


combined_filtered_wx_data <- filtered_pers_b_wx %>%
  full_join(filtered_pers_ub_wx) %>%
  full_join(filtered_trans_b_wx) %>%
  full_join(filtered_trans_ub_wx) %>%
  #removing first row of datetime that is 00:00:00 because the tree temp data does not have that datetimestep 
  slice(-1)
```

Adding in a date and time column, then a phase column, to try to fix issues in transitional burned SWin/out data

```{r}
combined_filtered_wx_data_V2 <- combined_filtered_wx_data %>%
  mutate(
    # Extract the date part
    date = date(datetime),
    # Extract the time part
    time = format(datetime, "%H:%M:%S"),
    # Convert time, daytime, and nighttime to POSIXct for comparison
    time = hms(time),
    daytime = hms(daytime),
    nighttime = hms(nighttime)
  ) %>%
  mutate(phase = case_when(
    time >= daytime & time < nighttime ~ "day",
    time < daytime | time >= nighttime ~ "night",
    TRUE ~ NA_character_  # Handle cases where none of the conditions match
  )) %>%
  select(c(-daytime, -nighttime)) %>%
  select(datetime, date, time, phase, everything())
```

```{r}
#plotting to see if changes made with date and time column fix the issues for transitional burned wx data

trans_b_wx_V2 <- combined_filtered_wx_data_V2 %>%
  filter(zone == "transitional")

trans_b_wx_plot_V2 <- ggplot(data = trans_b_wx_V2) +
  geom_line(aes(x = datetime, y = SWin_Avg), color = "red") +
  geom_line(aes(x = datetime, y = SWout_Avg), color = "blue") + 
  facet_wrap(~burn_status + phase)

trans_b_wx_plot_V2
```

Tree temp data wrangling to match wx station combined dataframes - south only tree temp data

```{r}
#this has gb/db/ub burn status
s_daily_energy <- avg_s_all_treetemps %>%
  select(datetime, phase, zone, burn_status, temp, tree_LWout_wperm2, energy_MJ) %>%
  rename(tree_LWout_MJ = "energy_MJ") %>%
  mutate(
    date = as.Date(datetime),                # Extract the date part
    time = format(datetime, "%H:%M:%S")      # Extract the time part
  ) %>%
  select(datetime, date, time, everything())
```

```{r}
##USE THIS VERSION!
#creating a full s_daily_energy dataframe that only has unburned and burned (average of gb and db data) so that the weather station data can be combined

##creating only a burned dataframe to get averages for all temp and R values that are averaging the green burned and dead burned values
s_daily_energy_burned <- s_daily_energy %>%
  filter(burn_status %in% c("green burn", "dead burn")) %>%
  group_by(datetime, date, time, phase, zone) %>%
  summarise(
    temp = mean(temp, na.rm = TRUE),
    tree_LWout_wperm2 = mean(tree_LWout_wperm2, na.rm = TRUE),
    tree_LWout_MJ = mean(tree_LWout_MJ, na.rm = TRUE)
  ) %>%
  #adding back in a burn_status column for burned
  mutate(burn_status = "burned") %>%
  select(datetime, date, time, phase, zone, burn_status, everything())

##creating only an unburned dataframe to join with above burned dataframe
s_daily_energy_unburned <- s_daily_energy %>%
  filter(burn_status == "unburned")
```

```{r}
#combining burned and unburned dataframe for tree temps

s_daily_energy_burned_unburned <- s_daily_energy_burned %>%
  full_join(s_daily_energy_unburned)
```

```{r}
#combining wx station R data and tree LWout data
combined_wx_treeRout_data <- combined_filtered_wx_data %>%
  full_join(s_daily_energy_burned_unburned) %>%
  drop_na() %>%
  select(datetime, date, time, phase, everything())
```

```{r}
#creating a daily and nightly average dataframe that just gives one reading per day/night that is the average of the whole day/night
daily_avg_combined_R_data <- combined_wx_treeRout_data %>%
  group_by(date, zone, burn_status, phase) %>%           # Group by the 'date' column
  summarize(across(everything(), mean, na.rm = TRUE)) %>%
  select(-time)
```

## Plotting Wx R data and Tree LWout data

```{r}
# Define custom colors and line types
color_values <- c(
  "SWin_Avg" = "#D95F02",
  "SWout_Avg" = "#E6AB02",
  "LWin_Avg" = "#66A61E",
  "LWout_Avg" = "#A6761D",
  "tree_LWout_avg_wperm2" = "#7570B3", 
  "tree_LWout_avg_MJ" = "#E7298A"
)

# Define line types based on burn_status
line_types <- c(
  "burned" = "solid",
  "unburned" = "dashed"
)

#changing labels of values in plots for the legend
color_labels <- c(
  "SWin_Avg" = "Shortwave In (Avg)",
  "SWout_Avg" = "Shortwave Out (Avg)",
  "LWin_Avg" = "Longwave In (Avg)",
  "LWout_Avg" = "Longwave Out (Avg)",
  "tree_LWout_avg_wperm2" = "Tree LW Out (Avg)"  # New label for the specific line
)

```

Plotting Weather Station SWin/out by zone and day/night

```{r}

```

This plot looks really scattered, and the y-values are too spread out, so I am going to try to plot a different way below

```{r}
test_wxR_plot <- ggplot(daily_avg_combined_R_data) +
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg", linetype = burn_status)) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg", linetype = burn_status)) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg", linetype = burn_status)) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg", linetype = burn_status)) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2", linetype = burn_status)) +
  facet_wrap(~ zone + phase + burn_status, scales = "free_y", dir = "v") +  # Facet by zone and phase
  labs(
    title = "Average Daily Radiation Components",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable",
    linetype = "Burn Status"
  ) +
  theme_minimal() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values) +  # Customize color scheme
  scale_linetype_manual(values = line_types)  # Customize line types

# Print the plot
print(test_wxR_plot)
```

Plotting day-only SW and LW plots, with a separate tree RLout plot? Using ggarrange to get a better layout

```{r}
#package for using ggarrange
library(ggpubr)

#pers dataframea to plot from
pers_b_combined_R_data <- daily_avg_combined_R_data %>%
  filter(burn_status == "burned") %>%
  filter(zone == "persistent")

pers_ub_combined_R_data <- daily_avg_combined_R_data %>%
  filter(burn_status == "unburned") %>%
  filter(zone == "persistent")

#trans dataframea to plot from
trans_b_combined_R_data <- daily_avg_combined_R_data %>%
  filter(burn_status == "burned") %>%
  filter(zone == "transitional")

trans_ub_combined_R_data <- daily_avg_combined_R_data %>%
  filter(burn_status == "unburned") %>%
  filter(zone == "transitional")
```

```{r}
#plotting seperate ggplots to combine with ggarrange
 
##pers_burned
pers_b_wxR_plot <- ggplot(pers_b_combined_R_data) +
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2")) +
  facet_wrap(~ phase, scales = "free_y", dir = "v") +  # Facet by zone and phase
  labs(
    title = "Persistent Burned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable"
  ) +
  theme_minimal() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels)  # Customize color and labels

pers_b_wxR_plot

##pers_burned
pers_ub_wxR_plot <- ggplot(pers_ub_combined_R_data) +
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2")) +
  facet_wrap(~ phase, scales = "free_y", dir = "v") +  # Facet by zone and phase
  labs(
    title = "Persistent Unburned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable"
  ) +
  theme_minimal() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels)  # Customize color and labels

pers_ub_wxR_plot
```

\*\* the day and night SWin/out data seems to be switched for the transitional zone in the burned status... not sure why this is? Need to parse this out more!

```{r}
##trans_burned
trans_b_wxR_plot <- ggplot(trans_b_combined_R_data) +
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2")) +
  facet_wrap(~ phase, scales = "free_y", dir = "v") +  # Facet by phase
  labs(
    title = "Transitional Burned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable"
  ) +
  theme_minimal() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels)  # Customize color and labels

trans_b_wxR_plot

##trans_unburned
trans_ub_wxR_plot <- ggplot(trans_ub_combined_R_data) +
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2")) +
  facet_wrap(~ phase, scales = "free_y", dir = "v") +  # Facet by zone and phase
  labs(
    title = "Transitional Unburned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable"
  ) +
  theme_minimal() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels)  # Customize color and labels

trans_ub_wxR_plot
```

Combining and arranging plots

```{r}
arranged_plots <- ggarrange(pers_b_wxR_plot,trans_b_wxR_plot, pers_ub_wxR_plot, trans_ub_wxR_plot, ncol = 2, nrow = 2, common.legend = TRUE, legend = "right")

arranged_plots
```

As of 2024-08-16, need to figure out weird issues with transitional burned data SWin/out being switched for day/night and transitional unburned data gap in SWin/out

-   Testing transitional weather dataframes from beginning of datawrangling

```{r}
transb_wx_plot <- ggplot(data = filtered_trans_b_wx) +
  geom_line(aes(x = datetime, y = SWin_Avg), color = "red") + 
  geom_line(aes(x = datetime, y = SWout_Avg), color = "blue")

transb_wx_plot
```

\

```{r}

```

# New LWout Dataframes

```{r}
#creating a RLout dataframe for all zones/burn status

#full 15-minute dataframe
full_LWout_data <- all_treetemps %>%
  select(datetime, zone, burn_status, aspect, tree_RL_out, energy_J) %>%
  mutate(
    burn_status = case_when(
      site == "pers_burned" ~ "burned",
      site == "pers_unburned" ~ "unburned",
      site == "trans_burned" ~ "burned",
      site == "trans_unburned" ~ "unburned",
      TRUE ~ NA_character_  # Or specify another value or condition as needed
    ),
    zone = case_when(
      site == "pers_burned" ~ "persistent",
      site == "pers_unburned" ~ "persistent",
      site == "trans_burned" ~ "transitional",
      site == "trans_unburned" ~ "transitional",
      TRUE ~ NA_character_  # Or specify another value or condition as needed
    )
  ) %>%
  mutate(
    # Extract the date part
    date = date(datetime),
    # Extract the time part
    time = format(datetime, "%H:%M:%S")
  ) %>%
  select(-site) %>%
  select(datetime, date, time, zone, burn_status, aspect, everything()) %>%
  #adding in a phase column to parse out day and night times
  mutate(time = hms(time)) %>%
  mutate(phase = case_when(
    time >= daytime & time < nighttime ~ "day",
    time < daytime | time >= nighttime ~ "night",
    TRUE ~ NA_character_  # Handle cases where none of the conditions match
  ))
```

```{r}
#day average daily dataframes for RLout - taking the average of daytime RLout readings, for SOUTH ASPECT ONLY
dt_avg_LW_out_data <- full_LWout_data %>%
  filter(phase == "day", aspect == "south") %>%
  group_by(date, zone, burn_status, phase) %>%
  summarize(
    avg_tree_RL_out = round(mean(tree_RL_out, na.rm = TRUE), 3),
    .groups = 'drop'  # Ensure grouping is dropped after summarizing
  ) %>%
  rename(dt_avg_tree_LWout_wperm2 = avg_tree_RL_out)
```
