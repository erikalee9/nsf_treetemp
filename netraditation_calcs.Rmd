---
title: "netradiation_calcs"
author: "Erika Lee"
date: "2024-07-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lterdatasampler)
library(dplyr)
library(ggplot2)
library(readr)
library(readxl)
library(lubridate)
library(plotly)
library(openxlsx)
library(plotly)
library(rstatix)
library(htmlwidgets)
library(RColorBrewer)
library(patchwork)
library(hms)
library(ggpubr)
#package for scientific notation of numbers
library(scales)

setwd("/Volumes/wcnr-network/Research/Kampf/Private/field_data")
```

# Color Set Up

```{r}
#to display the colors
display.brewer.pal(n = 8, name = "Dark2")

#to get the hex number of the colors
brewer.pal(n = 8, name = "Dark2")
```

```{r}
#setting a color-blind friendly custom palette for gb/db/ubn- using RColorBrewer
##blue is unburned, orange is dead burned, green is green burned
three_custom_colors <- c("#D95F02","#1B7837", adjustcolor("#2166AC", alpha = 0.7))

## orange is burned, blue is unburned
two_custom_colors <- c("#D95F02", adjustcolor("#2166AC", alpha = 0.7))
```

```{r}
#to display the colors
display.brewer.pal(n = 8, name = "YlOrRd")

#to get the hex number of the colors
brewer.pal(n = 8, name = "YlOrRd")

#first color is incoming R, second color is outgoing R
solar_rad_colors <- c("#B10026", "#FD8D3C")
```

# Calling in Data

```{r}
#calling in weather station data from n-drive
##persistent zone
persb_wx_15min <- read_excel("nsf/pers_burned/pers_burned_wx_15min_r.xlsx") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST')) 

persub_wx_15min <- read_excel("nsf/pers_unburned/pers_unburned_wx_15min_r.xlsx") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST'))

##transitional
transb_wx_15min <- read_excel("nsf/trans_burned/trans_burned_wx_15min_r.xlsx") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST'))

transub_wx_15min <- read_excel("nsf/trans_unburned/trans_unburned_wx_15min_r.xlsx") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST'))
```

```{r}
#calling in newer persistent hourly data for burned/unburned sites
persb_wx_hourly <- read_csv("nsf/pers_burned/pers_burned_wx_hourly_r.csv") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S"), tz="MST"))

persub_wx_hourly <- read_csv("nsf/pers_unburned/pers_unburned_wx_hourly_r.csv") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S"), tz="MST"))
```

```{r}
#calling in tree temp data from n-drive
## burned
pers_b_aspects <- read_csv("nsf/105E_pers_burned/105E_pers_b_aspects.csv") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST'))

trans_b_aspects <- read_csv("nsf/105E_trans_burned/105E_trans_b_aspects.csv") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST'))

##unburned
pers_ub_aspects <- read_csv("nsf/105E_pers_unburned/105E_pers_ub_aspects.csv") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST'))

trans_ub_aspects <- read_csv("nsf/105E_trans_unburned/105E_trans_ub_aspects.csv") %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST'))
```

Setting Constants

```{r}
#tree temp dataframes
start_time <- ymd_hms("2024-02-02 00:00:00", tz = "America/Denver")
end_time <- ymd_hms("2024-05-25 00:00:00", tz = "America/Denver")

#setting a day and night time 
daytime <- hms("08:00:00")
nighttime <- hms("17:00:00")
```

```{r}
#filtering temp data
filtered_pers_b_aspects <- pers_b_aspects %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST')) %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_pers_ub_aspects <- pers_ub_aspects %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST')) %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_trans_b_aspects <- trans_b_aspects %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST')) %>%
  filter(datetime >= start_time & datetime <= end_time)

filtered_trans_ub_aspects <- trans_ub_aspects %>%
  mutate(datetime = as.POSIXct(datetime, format=("%Y-%m-%d %H:%M:%S")), datetime = force_tz(datetime, tz = 'MST')) %>%
  filter(datetime >= start_time & datetime <= end_time)
```

```{r}
#setting a consistent timeframe for all tree temp data for all burned/unburned zones
##has to start at 2024-02-02 due to errors in data at transitional burned site

#adding in a burn status column to the aspect dataframes
filtered_pers_b_aspects <- filtered_pers_b_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "gb") ~ "green burn",
    startsWith(tree_name, "db") ~ "dead burn",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "persistent")

filtered_pers_ub_aspects <- filtered_pers_ub_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "ub") ~ "unburned",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "persistent")

filtered_trans_b_aspects <- filtered_trans_b_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "gb") ~ "green burn",
    startsWith(tree_name, "db") ~ "dead burn",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  #adding a zone column
  mutate(zone = "transitional")

filtered_trans_ub_aspects <- filtered_trans_ub_aspects %>%
  mutate(burn_status = case_when(
    startsWith(tree_name, "ub") ~ "unburned",
    TRUE ~ NA_character_  # Optional: handle other cases if needed
  )) %>%
  mutate(zone = "transitional")
```

```{r}
#creating one compiled dataframe that has all tree temps in it for all trees, not just an average

all_treetemps <- bind_rows(filtered_pers_b_aspects, filtered_pers_ub_aspects, filtered_trans_b_aspects, filtered_trans_ub_aspects)
```

# RL for trees Calculations

Create a 15 min LWout calculation for trees based on the tree temp

```{r}
# Constants
stefan_boltzmann_constant <- 5.67e-8
emissivity <- 0.97
#wedll depth and circumference are in meters
welldepth <- 1
circumference <- 0.40
#average circumference of a lodgepole is ~ 16 inches = 0.40 meters
#picking an average unit depth for well depth of 1 meter

#constant for m2 
m2 = welldepth*circumference

# Define the time interval (15 minutes in seconds)
time_interval_seconds <- 15 * 60

# Calculate incoming longwave radiation and add to dataframe
all_treetemps <- all_treetemps %>%
  #add a date column for calculations later
  mutate(date = as_date(datetime)) %>%
  mutate(
    temp_k= temp + 273.15, # Convert temperature to Kelvin
    tree_RL_out = emissivity * stefan_boltzmann_constant * (temp_k^4) # Calculate longwave radiation
  ) %>%
#the RL_in units are W/m2, the m2 component is 
  #calculating watz (W)
  #W is = to J/s
  mutate(W = tree_RL_out*m2) %>%
  # Convert instantaneous power (W) to energy (J) for each 15-minute interval
  mutate(energy_J = W * time_interval_seconds) %>%
  #adding in a time column for day/night parsing later
  mutate(time = format(datetime, "%H:%M:%S")) %>%
  select(datetime, date, time, everything())
```

Southern temp tree average - averaging all the gb/db/ub trees instead of analyzing each individual tree

```{r}
#creating a dataframe that is the average of the tree temps by burn_status and zone, only southern temps
avg_s_all_treetemps <- all_treetemps %>%
  filter(aspect == "south") %>%
  group_by(datetime, zone, burn_status) %>%
  # Calculate the mean of all relevant columns by group
  summarize(
    temp = mean(temp, na.rm = TRUE), 
    temp_k = mean(temp_k, na.rm = TRUE), 
    tree_LWout_wperm2 = mean(tree_RL_out, na.rm = TRUE), 
    W = mean(W, na.rm = TRUE), 
    energy_J = mean(energy_J, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  # Adding in date, time, and phase columns
  mutate(
    date = as.Date(datetime),
    time = format(datetime, "%H:%M:%S"),
    time_hms = hms::as_hms(time),  # Convert to hms object for phase calculation
    phase = case_when(
      time_hms >= hms::as_hms("08:00:00") & time_hms < hms::as_hms("17:00:00") ~ "day",
      time_hms < hms::as_hms("08:00:00") | time_hms >= hms::as_hms("17:00:00") ~ "night",
      TRUE ~ NA_character_
    ),
    energy_MJ = energy_J / 1e6  # Conversion to MJ
  ) %>%
  select(datetime, date, time, phase, everything())  # Final selection
```

```{r}
#creating a daily energy dataframe for the trees LWout values (w/m2 and MJ) - to be used later with the weather station radiation components and plotting!
s_daily_avg_tree_e <- avg_s_all_treetemps %>%
  select(datetime, date, time, phase, zone, burn_status, tree_LWout_wperm2, energy_MJ) %>%
  #grouping to get daily average
  group_by(date, phase, burn_status, zone) %>%
  summarize(tree_LWout_avg_wperm2 = mean(tree_LWout_wperm2, na.rm = TRUE), tree_LWout_avg_MJ = mean(energy_MJ, na.rm = TRUE))
```

# Final Day/Night Plots

-   \*\* Important plots, using these in thesis!

```{r}
#MJ plot
s_dtnt_avg_e_MJ_plot <- ggplot(s_daily_avg_tree_e, aes(x = date, y = tree_LWout_avg_MJ, color = burn_status)) +
  geom_line() +   # Add lines
  labs(title = "South Aspect 24-hour Avg LWout (MJ) from Trees",
       x = "Date",
       y = "Avg LW out (MJ)",
       color = "Burn Status") +
  theme_bw() +
  facet_wrap(~ zone + phase, dir = "v") +
  scale_color_manual(values = three_custom_colors)

s_dtnt_avg_e_MJ_plot
```

```{r}
#w per m2 plot
s_dtnt_avg_e_wperm2_plot <- ggplot(s_daily_avg_tree_e, aes(x = date, y = tree_LWout_avg_wperm2, color = burn_status)) +
  geom_line() +   # Add lines
  labs(title = "South Aspect 24-hour Avg LWout (W/m2) from Trees",
       x = "Date",
       y = "Avg LW out (W/m2)",
       color = "Burn Status") +
  theme_bw() +
  facet_wrap(~ zone + phase, dir = "v") +
  scale_color_manual(values = three_custom_colors)

s_dtnt_avg_e_wperm2_plot
```

```{r}
#saving plots with ggsave, then manually moved to computer's plot folder under r project folder
ggsave(filename = "s_dtnt_avg_e_MJ_plot.png", plot = s_dtnt_avg_e_MJ_plot, width = 10, height = 8, dpi = 300)

ggsave(filename = "s_dtnt_avg_e_wperm2_plot.png", plot = s_dtnt_avg_e_wperm2_plot, width = 10, height = 8, dpi = 300)
```

# Tree RL + Weather Station Data

## Data Wrangling

### Weather station data

```{r}
#filtered weather station data
filtered_pers_b_wx <- persb_wx_15min  %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  mutate(zone = "persistent") %>%
  mutate(burn_status = "burned") %>%
  mutate(date = as_date(datetime), time = format(datetime, "%H:%M:%S"))%>%
  select(c(datetime, date, time, zone, burn_status, SWin_Avg, SWout_Avg, LWin_Avg, LWout_Avg))


filtered_pers_ub_wx <- persub_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  mutate(zone = "persistent") %>%
  mutate(burn_status = "unburned") %>%
  mutate(date = as_date(datetime),time = format(datetime, "%H:%M:%S")) %>%
  select(c(datetime, date, time, zone, burn_status, SWin_Avg, SWout_Avg, LWin_Avg, LWout_Avg))

#persistent_burned_hourly
filtered_pers_b_hourly_wx <- persb_wx_hourly  %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  mutate(zone = "persistent") %>%
  mutate(burn_status = "burned") %>%
  mutate(date = as_date(datetime), time = format(datetime, "%H:%M:%S"))%>%
  select(c(datetime, date, time, zone, burn_status, SWin_Avg, SWout_Avg, LWin_Avg, LWout_Avg))

#persistent_unburned_hourly
filtered_pers_ub_hourly_wx <- persub_wx_hourly  %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  mutate(zone = "persistent") %>%
  mutate(burn_status = "unburned") %>%
  mutate(date = as_date(datetime), time = format(datetime, "%H:%M:%S"))%>%
  select(c(datetime, date, time, zone, burn_status, SWin_Avg, SWout_Avg, LWin_Avg, LWout_Avg))

filtered_trans_b_wx <- transb_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  mutate(zone = "transitional") %>%
  mutate(burn_status = "burned") %>%
  mutate(date = as_date(datetime),time = format(datetime, "%H:%M:%S"))%>%
  select(c(datetime, date, time, zone, burn_status, SWin_Avg, SWout_Avg, LWin_Avg, LWout_Avg))

filtered_trans_ub_wx <- transub_wx_15min %>%
  filter(datetime >= start_time & datetime <= end_time) %>%
  mutate(zone = "transitional") %>%
  mutate(burn_status = "unburned") %>%
  mutate(date = as_date(datetime),time = format(datetime, "%H:%M:%S"))%>%
  select(c(datetime, date, time, zone, burn_status, SWin_Avg, SWout_Avg, LWin_Avg, LWout_Avg))

#ensuring that the values are numeric for all columns
# Ensure all joining columns have the same type across all dataframes
#also adding in phase column
filtered_pers_b_wx <- filtered_pers_b_wx %>%
  mutate(
    SWin_Avg = as.numeric(SWin_Avg),
    SWout_Avg = as.numeric(SWout_Avg),
    LWin_Avg = as.numeric(LWin_Avg),
    LWout_Avg = as.numeric(LWout_Avg)
  ) %>%
  mutate(
    # Extract the date part
    date = as.Date(datetime),
    # Extract the time part
    time = format(datetime, "%H:%M:%S")
  ) %>%
  # Convert time to hms object for comparison
  mutate(
    time_hms = hms::as_hms(time)
  ) %>%
  mutate(
    phase = case_when(
      time_hms >= hms::as_hms("08:00:00") & time_hms < hms::as_hms("17:00:00") ~ "day",
      time_hms < hms::as_hms("08:00:00") | time_hms >= hms::as_hms("17:00:00") ~ "night",
      TRUE ~ NA_character_
    )
  ) %>%
  select(datetime, date, time, phase, everything())


filtered_pers_ub_wx <- filtered_pers_ub_wx %>%
  mutate(
    SWin_Avg = as.numeric(SWin_Avg),
    SWout_Avg = as.numeric(SWout_Avg),
    LWin_Avg = as.numeric(LWin_Avg),
    LWout_Avg = as.numeric(LWout_Avg)
  ) %>%
  mutate(
    # Extract the date part
    date = as.Date(datetime),
    # Extract the time part
    time = format(datetime, "%H:%M:%S"), 
    # Convert time to hms object for comparison
    time_hms = hms(time)
  ) %>%
  mutate(
    phase = case_when(
      time_hms >= hms("08:00:00") & time_hms < hms("17:00:00") ~ "day",
      time_hms < hms("08:00:00") | time_hms >= hms("17:00:00") ~ "night",
      TRUE ~ NA_character_  # Handle cases where none of the conditions match
    )
  ) %>%
  select(datetime, date, time, phase, everything())

#filtered persb_hourly_wx
filtered_pers_b_hourly_wx <- filtered_pers_b_hourly_wx %>%
  mutate(
    SWin_Avg = as.numeric(SWin_Avg),
    SWout_Avg = as.numeric(SWout_Avg),
    LWin_Avg = as.numeric(LWin_Avg),
    LWout_Avg = as.numeric(LWout_Avg)
  ) %>%
  mutate(
    # Extract the date part
    date = as.Date(datetime),
    # Extract the time part
    time = format(datetime, "%H:%M:%S")
  ) %>%
  # Convert time to hms object for comparison
  mutate(
    time_hms = hms::as_hms(time)
  ) %>%
  mutate(
    phase = case_when(
      time_hms >= hms::as_hms("08:00:00") & time_hms < hms::as_hms("17:00:00") ~ "day",
      time_hms < hms::as_hms("08:00:00") | time_hms >= hms::as_hms("17:00:00") ~ "night",
      TRUE ~ NA_character_
    )
  ) %>%
  select(datetime, date, time, phase, everything())

#filtered persub_hourly_wx
filtered_pers_ub_hourly_wx <- filtered_pers_ub_hourly_wx %>%
  mutate(
    SWin_Avg = as.numeric(SWin_Avg),
    SWout_Avg = as.numeric(SWout_Avg),
    LWin_Avg = as.numeric(LWin_Avg),
    LWout_Avg = as.numeric(LWout_Avg)
  ) %>%
  mutate(
    # Extract the date part
    date = as.Date(datetime),
    # Extract the time part
    time = format(datetime, "%H:%M:%S")
  ) %>%
  # Convert time to hms object for comparison
  mutate(
    time_hms = hms::as_hms(time)
  ) %>%
  mutate(
    phase = case_when(
      time_hms >= hms::as_hms("08:00:00") & time_hms < hms::as_hms("17:00:00") ~ "day",
      time_hms < hms::as_hms("08:00:00") | time_hms >= hms::as_hms("17:00:00") ~ "night",
      TRUE ~ NA_character_
    )
  ) %>%
  select(datetime, date, time, phase, everything())


filtered_trans_b_wx <- filtered_trans_b_wx %>%
  mutate(
    SWin_Avg = as.numeric(SWin_Avg),
    SWout_Avg = as.numeric(SWout_Avg),
    LWin_Avg = as.numeric(LWin_Avg),
    LWout_Avg = as.numeric(LWout_Avg)
  ) %>%
  mutate(
    # Extract the date part
    date = as.Date(datetime),
    # Extract the time part
    time = format(datetime, "%H:%M:%S")
  ) %>%
  # Convert time to hms object for comparison
  mutate(
    time_hms = hms::as_hms(time)
  ) %>%
  mutate(
    phase = case_when(
      time_hms >= hms::as_hms("08:00:00") & time_hms < hms::as_hms("17:00:00") ~ "day",
      time_hms < hms::as_hms("08:00:00") | time_hms >= hms::as_hms("17:00:00") ~ "night",
      TRUE ~ NA_character_
    )
  ) %>%
  select(datetime, date, time, phase, everything())

filtered_trans_ub_wx <- filtered_trans_ub_wx %>%
  mutate(
    SWin_Avg = as.numeric(SWin_Avg),
    SWout_Avg = as.numeric(SWout_Avg),
    LWin_Avg = as.numeric(LWin_Avg),
    LWout_Avg = as.numeric(LWout_Avg)
  ) %>%
  mutate(
    # Extract the date part
    date = as.Date(datetime),
    # Extract the time part
    time = format(datetime, "%H:%M:%S")
  ) %>%
  # Convert time to hms object for comparison
  mutate(
    time_hms = hms::as_hms(time)
  ) %>%
  mutate(
    phase = case_when(
      time_hms >= hms::as_hms("08:00:00") & time_hms < hms::as_hms("17:00:00") ~ "day",
      time_hms < hms::as_hms("08:00:00") | time_hms >= hms::as_hms("17:00:00") ~ "night",
      TRUE ~ NA_character_
    )
  ) %>%
  select(datetime, date, time, phase, everything())


#making one combined dataframe to pull from it needed - DONT USE THIS! IT is including the persb/ub 15-minute data not hourly
combined_filtered_wx_data <- filtered_pers_b_wx %>%
  full_join(filtered_pers_ub_wx) %>%
  full_join(filtered_trans_b_wx) %>%
  full_join(filtered_trans_ub_wx)
```

### Creating Day-only combined and individual dataframes

-   daytime is from 8:00 to 17:00 MST

```{r}
#day-only averaged dataframes for all locations, using the persistent-hourly weather data so I can have data that goes into June

day_avg_persb_hourly_wx <- filtered_pers_b_hourly_wx %>%
  group_by(date, zone, burn_status, phase) %>%
  summarize(across(everything(), mean, na.rm = TRUE)) %>%
  select(-c(datetime, time, time_hms)) %>%
  filter(phase == "day")

day_avg_persub_hourly_wx <- filtered_pers_ub_hourly_wx %>%
  group_by(date, zone, burn_status, phase) %>%
  summarize(across(everything(), mean, na.rm = TRUE)) %>%
  select(-c(datetime, time, time_hms)) %>%
  filter(phase == "day")

day_avg_transb_wx <- filtered_trans_b_wx %>%
  group_by(date, zone, burn_status, phase) %>%
  summarize(across(everything(), mean, na.rm = TRUE)) %>%
  select(-c(datetime, time, time_hms)) %>%
  filter(phase == "day")

day_avg_transub_wx <- filtered_trans_ub_wx %>%
  group_by(date, zone, burn_status, phase) %>%
  summarize(across(everything(), mean, na.rm = TRUE)) %>%
  select(-c(datetime, time, time_hms)) %>%
  filter(phase == "day")
```

```{r}
#creating a day-only combined dataframe to use for radiation and weather station plots
day_combined_filtered_wx_data <- day_avg_persb_hourly_wx %>%
  full_join(day_avg_persub_hourly_wx) %>%
  full_join(day_avg_transb_wx) %>%
  full_join(day_avg_transub_wx)
```

```{r}
#creating a averaged day-only filtered wx data
##** use this to join with the tree LWout dataframe!
day_avg_filtered_wx_data <- day_combined_filtered_wx_data %>%
  group_by(date, zone, burn_status, phase) %>%
  summarize(across(everything(), mean, na.rm = TRUE)) %>%
  select(-c(datetime, time, time_hms))
```

Tree temp data wrangling to match wx station combined dataframes - south only tree temp data

```{r}
#this has gb/db/ub burn status
s_daily_energy <- avg_s_all_treetemps %>%
  select(datetime, phase, zone, burn_status, temp, tree_LWout_wperm2, energy_MJ) %>%
  rename(tree_LWout_MJ = "energy_MJ") %>%
  mutate(
    date = as.Date(datetime),                # Extract the date part
    time = format(datetime, "%H:%M:%S")      # Extract the time part
  ) %>%
  select(datetime, date, time, everything())
```

```{r}
##USE THIS VERSION!
#creating a full s_daily_energy dataframe that only has unburned and burned (average of gb and db data) so that the weather station data can be combined

##creating only a burned dataframe to get averages for all temp and R values that are averaging the green burned and dead burned values
s_daily_energy_burned <- s_daily_energy %>%
  filter(burn_status %in% c("green burn", "dead burn")) %>%
  group_by(datetime, date, time, phase, zone) %>%
  summarise(
    temp = mean(temp, na.rm = TRUE),
    tree_LWout_wperm2 = mean(tree_LWout_wperm2, na.rm = TRUE),
    tree_LWout_MJ = mean(tree_LWout_MJ, na.rm = TRUE)
  ) %>%
  #adding back in a burn_status column for burned
  mutate(burn_status = "burned") %>%
  select(datetime, date, time, phase, zone, burn_status, everything())

##creating only an unburned dataframe to join with above burned dataframe
s_daily_energy_unburned <- s_daily_energy %>%
  filter(burn_status == "unburned")
```

```{r}
#combining burned and unburned dataframe for tree temps
s_daily_energy_burned_unburned <- s_daily_energy_burned %>%
  full_join(s_daily_energy_unburned) %>%
  #filtering to match the datetime range of weather station data
  filter(datetime >= start_time & datetime <= end_time)
```

```{r}
#day-only south energy dataframe
day_s_daily_avg_tree_LWout <- s_daily_energy_burned_unburned %>%
  filter(phase == "day")
```

```{r}
#creating a daily average of the above dataframe
##Use this for the radiation and LWout plots!
day_avg_filtered_tree_LWout_data <- day_s_daily_avg_tree_LWout %>%
  group_by(date, zone, burn_status, phase) %>%
  summarize(across(everything(), mean, na.rm = TRUE)) %>%
  select(-c(datetime, time))
```

```{r}
#combining day-only average wx and tree LWout data
##Use this for the radiation and LWout plots!
day_final_combined_wx_treeLWout_data <- day_combined_filtered_wx_data %>%
  full_join(day_avg_filtered_tree_LWout_data) %>%
  #by dropping NAs, I am removing the points where we did not have SWin/out data for the transitional burned weather station
  drop_na()
```

```{r}
#NOT USING? 
#combining wx station R data and tree LWout data
##Use this for the radiation and LWout plots!
combined_wx_treeRout_data <- combined_filtered_wx_data %>%
  full_join(s_daily_energy_burned_unburned) %>%
  drop_na() %>%
  select(datetime, date, time, phase, everything())
```

```{r}
#creating a daily and nightly average dataframe that just gives one reading per day/night that is the average of the whole day/night
daynight_avg_combined_R_data <- combined_wx_treeRout_data %>%
  group_by(date, zone, burn_status, phase) %>%
  summarize(across(everything(), mean, na.rm = TRUE)) %>%
  select(-time)
```

## Plotting Wx R data and Tree LWout data

```{r}
# Define custom colors and line types
color_values <- c(
  "SWin_Avg" = "#D95F02",
  "SWout_Avg" = "#E6AB02",
  "LWin_Avg" = "#66A61E",
  "LWout_Avg" = "#A6761D",
  "tree_LWout_avg_wperm2" = "#7570B3", 
  "tree_LWout_avg_MJ" = "#E7298A"
)

# Define line types
line_types <- c(
  "Weather Station" = "solid",
  "Tree Temperature Sensors" = "dashed"
)

#changing labels of values in plots for the legend
color_labels <- c(
  "SWin_Avg" = "Shortwave In (Avg)",
  "SWout_Avg" = "Shortwave Out (Avg)",
  "LWin_Avg" = "Longwave In (Avg)",
  "LWout_Avg" = "Longwave Out (Avg)",
  "tree_LWout_avg_wperm2" = "Tree LW Out (Avg)"  # New label for the specific line
)

```

Plotting Weather Station SWin/out by zone and day/night + tree_LWout

\*\* Use the first plot, not the individual ones!

```{r}
#doing a partial facet wrap partial arrange by burn_status
##creating dataframes to use in plots
burned_day_s_avg_values <- day_final_combined_wx_treeLWout_data %>%
  filter(burn_status == "burned")

unburned_day_s_avg_values <- day_final_combined_wx_treeLWout_data %>%
  filter(burn_status == "unburned")
```

```{r}
#plotting facet wrapped day radiation and tree LWout components - in two plots, then combining

## burned 
burned_day_s_avg_plot <- ggplot(data = burned_day_s_avg_values) + 
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2", linetype = "Tree Temperature Sensors")) +
  facet_wrap(~ zone + burn_status, scales = "free_y", dir = "h") +  # Facet by zone and phase
  labs(
    #title = "Transitional Unburned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable", 
    linetype = "Data Source"
    ) +
  theme_bw() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels) + 
  scale_linetype_manual(values = line_types)

burned_day_s_avg_plot

## unburned
unburned_day_s_avg_plot <- ggplot(data = unburned_day_s_avg_values) + 
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2", linetype = "Tree Temperature Sensors")) +
  facet_wrap(~ zone + burn_status, scales = "free_y", dir = "h") +  # Facet by zone and phase
  labs(
    #title = "Transitional Unburned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable", 
    linetype = "Data Source"
    ) +
  theme_bw() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels) + 
  scale_linetype_manual(values = line_types)

unburned_day_s_avg_plot
```

```{r}
#combinging and arranging burned/unburned plots

combined_wx_treeLWout_finalplot <- ggarrange(burned_day_s_avg_plot, unburned_day_s_avg_plot, ncol = 1, nrow = 2, common.legend = TRUE, legend = "right")

combined_wx_treeLWout_finalplot
```

```{r}
#saving arranged plot
ggsave(filename = "combined_wx_treeLWout_finalplot.png", plot = combined_wx_treeLWout_finalplot, width = 14, height = 9, dpi = 300)
```

```{r}
#pers dataframes to plot from
day_pers_b_combined_R_data <- day_final_combined_wx_treeLWout_data %>%
  filter(burn_status == "burned") %>%
  filter(zone == "persistent")

day_pers_ub_combined_R_data <- day_final_combined_wx_treeLWout_data %>%
  filter(burn_status == "unburned") %>%
  filter(zone == "persistent")

#trans dataframea to plot from
day_trans_b_combined_R_data <- day_final_combined_wx_treeLWout_data %>%
  filter(burn_status == "burned") %>%
  filter(zone == "transitional")

day_trans_ub_combined_R_data <- day_final_combined_wx_treeLWout_data %>%
  filter(burn_status == "unburned") %>%
  filter(zone == "transitional")
```

```{r}
#plotting seperate ggplots to combine with ggarrange
 
##pers_burned
pers_b_wxR_plot <- ggplot(day_pers_b_combined_R_data) +
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2", linetype = "Tree Temperature Sensors")) +
  facet_wrap(~ phase, scales = "free_y", dir = "v") +  # Facet by zone and phase
  labs(
    title = "Persistent Burned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable", 
    linetype = "Data Source"
  ) +
  theme_minimal() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels) + 
  scale_linetype_manual(values = line_types)# Customize color and labels

pers_b_wxR_plot

##pers_burned
pers_ub_wxR_plot <- ggplot(day_pers_ub_combined_R_data) +
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2", linetype = "Tree Temperature Sensors")) +
  facet_wrap(~ phase, scales = "free_y", dir = "v") +  # Facet by zone and phase
  labs(
    title = "Persistent Unburned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable", 
    linetype = "Data Source"
  ) +
  theme_minimal() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels) + 
  scale_linetype_manual(values = line_types)# Customize color and labels

pers_ub_wxR_plot
```

```{r}
##trans_burned
trans_b_wxR_plot <- ggplot(day_trans_b_combined_R_data) +
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2", linetype = "Tree Temperature Sensors")) +
  facet_wrap(~ phase, scales = "free_y", dir = "v") +  # Facet by zone and phase
  labs(
    title = "Transitional Burned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable", 
    linetype = "Data Source"
  ) +
  theme_minimal() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels) + 
  scale_linetype_manual(values = line_types)# Customize color and labels

trans_b_wxR_plot

##trans_unburned
trans_ub_wxR_plot <- ggplot(day_trans_ub_combined_R_data) +
  geom_line(aes(x = date, y = SWin_Avg, color = "SWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = SWout_Avg, color = "SWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWin_Avg, color = "LWin_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = LWout_Avg, color = "LWout_Avg", linetype = "Weather Station")) +
  geom_line(aes(x = date, y = tree_LWout_wperm2, color = "tree_LWout_avg_wperm2", linetype = "Tree Temperature Sensors")) +
  facet_wrap(~ phase, scales = "free_y", dir = "v") +  # Facet by zone and phase
  labs(
    title = "Transitional Unburned",
    x = "Date",
    y = "Radiation components (W/m2)",
    color = "Variable", 
    linetype = "Data Source"
    ) +
  theme_minimal() +  # Use a minimal theme for a clean look
  scale_color_manual(values = color_values, labels = color_labels) + 
  scale_linetype_manual(values = line_types)

trans_ub_wxR_plot
```

Combining, arranging, and saving plots

```{r}
#combining
arranged_plots <- ggarrange(pers_b_wxR_plot,trans_b_wxR_plot, pers_ub_wxR_plot, trans_ub_wxR_plot, ncol = 2, nrow = 2, common.legend = TRUE, legend = "right")

arranged_plots

#saving ggplot as high quality png
ggsave("arranged_plots.png", arranged_plots, width = 8, height = 6, dpi = 300)
```

HAVEN'T WORKED ON ANYTHING ELSE BELOW THIS POINT AS OF 8/20/24

# New LWout Dataframes

```{r}
#creating a RLout dataframe for all zones/burn status

#full 15-minute dataframe
full_LWout_data <- all_treetemps %>%
  select(datetime, zone, burn_status, aspect, tree_RL_out, energy_J) %>%
  mutate(
    burn_status = case_when(
      site == "pers_burned" ~ "burned",
      site == "pers_unburned" ~ "unburned",
      site == "trans_burned" ~ "burned",
      site == "trans_unburned" ~ "unburned",
      TRUE ~ NA_character_  # Or specify another value or condition as needed
    ),
    zone = case_when(
      site == "pers_burned" ~ "persistent",
      site == "pers_unburned" ~ "persistent",
      site == "trans_burned" ~ "transitional",
      site == "trans_unburned" ~ "transitional",
      TRUE ~ NA_character_  # Or specify another value or condition as needed
    )
  ) %>%
  mutate(
    # Extract the date part
    date = date(datetime),
    # Extract the time part
    time = format(datetime, "%H:%M:%S")
  ) %>%
  select(-site) %>%
  select(datetime, date, time, zone, burn_status, aspect, everything()) %>%
  #adding in a phase column to parse out day and night times
  mutate(time = hms(time)) %>%
  mutate(phase = case_when(
    time >= daytime & time < nighttime ~ "day",
    time < daytime | time >= nighttime ~ "night",
    TRUE ~ NA_character_  # Handle cases where none of the conditions match
  ))
```

```{r}
#day average daily dataframes for RLout - taking the average of daytime RLout readings, for SOUTH ASPECT ONLY
dt_avg_LW_out_data <- full_LWout_data %>%
  filter(phase == "day", aspect == "south") %>%
  group_by(date, zone, burn_status, phase) %>%
  summarize(
    avg_tree_RL_out = round(mean(tree_RL_out, na.rm = TRUE), 3),
    .groups = 'drop'  # Ensure grouping is dropped after summarizing
  ) %>%
  rename(dt_avg_tree_LWout_wperm2 = avg_tree_RL_out)
```
